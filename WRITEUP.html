<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pal Optical - Absolute Master Dual Slip Tool (P.O.S.T.)</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

        :root {
            --primary: #000000;
            --accent: #000000;
            --success: #27ae60;
            --border: #000;
            --bg-color: #f4f7f6;
            --text-color: #000000;
            --card-bg: #fff;
            --sidebar-bg: #fff;
            --input-bg: #fff;
            --input-border: #ccc;
            --table-bg: #f8f9fa;
            --table-border: #000000;
            --overlay-bg: #fff;
            --overlay-text: #000000;
            --bypasses-bg: #eee;
            --waiver-bg: #fff0f0;
        }

        [data-theme="dark"] {
            --primary: #ffffff;
            --accent: #ffffff;
            --success: #05ff61;
            --border: #ffffff;
            --bg-color: #000000;
            --text-color: #ffffff;
            --card-bg: #000000;
            --sidebar-bg: #000000;
            --input-bg: #000000;
            --input-border: #ffffff;
            --table-bg: #000000;
            --table-border: #ffffff;
            --overlay-bg: #000000;
            --overlay-text: #ffffff;
            --bypasses-bg: var(--card-bg);
            --waiver-bg: #4a2a2a;
        }

        [data-theme="dark"] .input-row { background: var(--card-bg) !important; }
        [data-theme="dark"] .action-btn { background: var(--card-bg) !important; color: var(--text-color) !important; }
        [data-theme="dark"] .waiver-row { background: var(--card-bg) !important; }
        [data-theme="dark"] .bypasses-section { background: var(--card-bg) !important; }
        [data-theme="dark"] .sidebar input, [data-theme="dark"] .sidebar select { background: var(--input-bg) !important; color: var(--text-color) !important; border-color: var(--input-border) !important; }
        [data-theme="dark"] .sidebar-branding { color: var(--primary) !important; }
        [data-theme="dark"] .sidebar-branding p { color: var(--accent) !important; }

							/* --- ROTATE DEVICE OVERLAY --- */
#rotate-overlay {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #2c3e50;
    color: white;
    z-index: 99999; /* Highest possible z-index */
    text-align: center;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* If the screen is taller than it is wide (Portrait), show the overlay */
@media screen and (orientation: portrait) and (max-width: 900px) {
    #rotate-overlay {
        display: flex;
    }
    /* Stop the background from scrolling while the overlay is up */
    body {
        overflow: hidden !important; 
    }
}

										
        /* --- PLACEHOLDER COLORS --- */
        input::placeholder, textarea::placeholder { color: #000000 !important; opacity: 1; }
        [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color: #ffffff !important; opacity: 1; }

        body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }

        /* --- MEASUREMENT TOOL STYLES --- */
        .measure-btn {
            background: var(--primary); color: var(--card-bg); border: 1px solid var(--border);
            border-radius: 4px; cursor: pointer; padding: 0 8px; font-size: 1.2em; height: 32px;
            display: flex; align-items: center; justify-content: center;
        }
        .measure-btn:hover { opacity: 0.8; }
        
        #measureModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 11000; overflow-y: auto; flex-direction: column;
            align-items: center; justify-content: flex-start; padding-top: 20px;
        }
        .measure-content {
            background: white; width: 95%; max-width: 800px; padding: 20px;
            border-radius: 8px; text-align: center; color: black; position: relative;
        }
        #videoElement { width: 100%; max-width: 600px; background: #000; border-radius: 8px; display: none; margin: 0 auto; transform: rotate(180deg); }
        #photoCanvas { max-width: 100%; border: 2px solid blue; cursor: crosshair; display: none; margin: 10px auto; }
        .instruction-banner {
            background: #e9ecef; color: #333; padding: 10px; font-weight: bold;
            margin: 10px 0; border-radius: 4px; border: 1px solid #ccc;
        }
        .cam-controls { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        .cam-btn { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-start { background: #28a745; color: white; }
        .btn-snap { background: #007bff; color: white; }
        .btn-reset { background: #dc3545; color: white; }
        .btn-save-measure { background: #28a745; color: white; font-size: 1.1em; padding: 12px 24px; }
        .close-measure { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #333; font-weight: bold;}

        /* --- THEME TOGGLE --- */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; }
        input:checked+.slider { background-color: #33ff00; }
        input:checked+.slider:before { transform: translateX(26px); }

        /* --- P.O.S.T. BRANDING STYLES --- */
        .sidebar-branding { text-align: center; margin-bottom: 20px; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 15px; position: relative; }
        .sidebar-branding h1 { margin: 0; font-size: 2.2em; letter-spacing: 3px; font-weight: 900; }
        .sidebar-branding p { margin: 0; font-size: 0.85em; font-weight: bold; text-transform: uppercase; opacity: 0.8; color: var(--accent); }
        .theme-toggle { position: absolute; top: 10px; right: 10px; }
        .print-branding { position: absolute; top: 10px; right: 20px; text-align: right; line-height: 1.1; }
        .print-branding h2 { margin: 0; font-size: 1.5em; letter-spacing: 1px; font-weight: 900; }
        .print-branding p { margin: 0; font-size: 0.65em; font-weight: bold; text-transform: uppercase; }

        /* --- DISABLED PRINT BUTTON STYLES --- */
        #printBtn:disabled { background-color: #95a5a6 !important; color: #7f8c8d !important; cursor: not-allowed !important; opacity: 0.6; }
        .validation-message { color: #e74c3c; font-size: 0.75em; font-weight: bold; margin-top: 5px; display: none; padding: 5px; background: #fadbd8; border-radius: 4px; }
        .validation-message.visible { display: block; }

        /* --- OVERLAYS --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 10000; color: white; text-align: center; }
        #patientInfoOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; z-index: 9999; overflow-y: auto; align-items: flex-start; padding: 40px 0; }
        #languageModal, #newPtPrompt { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; z-index: 10000; justify-content: center; align-items: center; }

        .language-box, .prompt-box { background: var(--overlay-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); color: var(--overlay-text); width: 320px; text-align: center; }
        .language-box h2, .prompt-box h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; }
        .prompt-btn { width: 45%; padding: 10px; margin: 5px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9em; }
        .lang-option { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--table-bg); border: 2px solid var(--border); border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.2s; color: var(--text-color); }
        .lang-option:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .lang-btn-cancel { margin-top: 15px; background: transparent; border: none; color: var(--text-color); cursor: pointer; text-decoration: underline; font-size: 0.9em; }

        .login-box { background: var(--overlay-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); color: var(--overlay-text); width: 320px; }
        .login-box input { margin-bottom: 10px; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; width: 100%; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); }
        .login-btn { width: 100%; padding: 12px; background: var(--success); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* --- SEG HEIGHT ADJUSTMENT MODAL --- */
        #segHeightModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; z-index: 10000; justify-content: center; align-items: center; }
        .seght-box { background: var(--overlay-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); color: var(--overlay-text); width: 380px; text-align: center; }
        .seght-box h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; color: var(--primary); }
        .seght-box .message { margin-bottom: 20px; font-size: 0.95em; line-height: 1.5; }
        .seght-btn-group { display: flex; gap: 10px; justify-content: center; }
        .seght-btn { padding: 10px 25px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1em; }
        .seght-btn-yes { background: var(--success); color: white; }
        .seght-btn-yes:hover { background: #27ae60; }
        .seght-btn-no { background: #e74c3c; color: white; }
        .seght-btn-no:hover { background: #c0392b; }
        .seght-warning { display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; color: #856404; font-weight: bold; }

        /* --- REMAKE MODAL --- */
        #remakeModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; z-index: 10000; justify-content: center; align-items: center; }
        .remake-box { background: var(--overlay-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); color: var(--overlay-text); width: 420px; }
        .remake-box h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: var(--primary); }
        .remake-box label { display: block; margin-bottom: 10px; font-size: 0.9em; font-weight: bold; }
        .remake-box textarea { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 6px; font-size: 0.9em; background: var(--input-bg); color: var(--text-color); font-family: Arial, sans-serif; resize: vertical; min-height: 80px; box-sizing: border-box; margin-bottom: 15px; }
        .remake-btn-group { display: flex; gap: 10px; justify-content: flex-end; }
        .remake-btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95em; }
        .remake-btn-save { background: var(--success); color: white; }
        .remake-btn-save:hover { background: #27ae60; }
        .remake-btn-cancel { background: #95a5a6; color: white; }
        .remake-btn-cancel:hover { background: #7f8c8d; }

        /* --- PATIENT FORM INPUT STYLES (OVERLAY) --- */
        .info-sheet-container { background: var(--overlay-bg); color: var(--overlay-text); padding: 30px; border-radius: 8px; width: 90%; max-width: 800px; margin: auto; text-align: left; font-family: "Inter", sans-serif; }
        .info-sheet-container h2 { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; font-weight: 800; text-transform: uppercase; }
        .overlay-section { margin-bottom: 15px; border: 1px solid var(--border); padding: 10px; border-radius: 4px; }
        .overlay-label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--overlay-text); margin-bottom: 2px; text-transform: uppercase; }
        .overlay-input { width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); }
        .overlay-row { display: flex; gap: 10px; margin-bottom: 10px; }

        /* --- CATALOG & HISTORY --- */
        .catalog-container { flex: 1.2; padding: 20px; overflow-y: auto; border-right: 2px solid var(--border); background: var(--card-bg); }
        .search-box { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 16px; background: var(--input-bg); color: var(--text-color); }
        .category-buttons { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 15px; }
        .cat-btn { padding: 5px 10px; cursor: pointer; border: 1px solid var(--input-border); background: var(--table-bg); border-radius: 12px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; color: var(--text-color); }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .lens-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
        .lens-card { background: var(--card-bg); padding: 10px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); font-size: 0.75em; transition: 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between; color: var(--text-color); }
        .lens-card:hover { border-color: var(--accent); background: var(--table-bg); }
        .copay-btn { background: var(--success); color: white; border: none; padding: 6px; border-radius: 4px; font-size: 0.9em; margin-top: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .copay-btn:hover { background: #219150; }
        .history-section { margin-top: 30px; border-top: 3px solid var(--border); padding-top: 20px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.75em; color: var(--text-color); }
        .history-table th { text-align: left; background: var(--table-bg); padding: 8px; border-bottom: 2px solid var(--table-border); }
        .history-table tr.hist-row { cursor: pointer; transition: 0.2s; }
        .history-table tr.hist-row:hover { background: var(--table-bg); }
        .history-table td { padding: 8px; border-bottom: 1px solid var(--table-border); }

        /* --- WORKBENCH --- */
        .sidebar { flex: 1.6; background: var(--sidebar-bg); padding: 20px; overflow-y: auto; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); }
        h3 { margin: 15px 0 8px 0; font-size: 0.85em; border-bottom: 1px solid var(--border); color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .sidebar input, .sidebar select { padding: 7px; border: 1px solid var(--input-border); border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.9em; font-family: inherit; background: var(--input-bg); color: var(--text-color); }
        .bill-ui-table, .rx-ui-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; color: var(--text-color); }
        .bill-ui-table th, .rx-ui-table th { background: var(--table-bg); text-align: center; padding: 5px; border: 1px solid var(--table-border); }
        .bill-ui-table td, .rx-ui-table td { border: 1px solid var(--table-border); padding: 2px; }
        .bill-ui-table input { border: none; background: transparent; text-align: center; width: 100%; color: var(--text-color); }
        .action-btn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; font-weight: bold; background: var(--accent); color: white; border: none; border-radius: 4px; }
        .action-btn:disabled { background: #999; cursor: not-allowed; opacity: 0.6; }
        .waiver-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }
        .waiver-row input { margin: 0; width: auto; }
        .payment-box { background: var(--card-bg); padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; font-size: 0.9em; display: none; color: var(--text-color); }
        .pay-row { display: flex; gap: 15px; align-items: center; margin-bottom: 8px; font-weight: bold; }
        .card-sub-options { margin-left: 20px; display: none; grid-template-columns: 1fr 1fr; gap: 5px; font-weight: normal; font-size: 0.9em; }
        #check-input-area { display: none; align-items: center; gap: 5px; }
        .medicaid-options { background: var(--card-bg); padding: 10px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 10px; display: none; color: var(--text-color); }
        .school-options { background: var(--card-bg); padding: 10px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 10px; display: none; color: var(--text-color); }
        .color-section { display: flex; flex-wrap: wrap; gap: 10px; background: var(--table-bg); padding: 8px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 8px; font-size: 0.75em; font-weight: bold; color: var(--text-color); }
        .sig-pad-container { border: 2px dashed var(--input-border); background: var(--card-bg); margin-top: 10px; border-radius: 6px; }
        #sig-canvas { width: 100%; height: 100px; cursor: crosshair; touch-action: none; }
        .sig-tools { display: flex; justify-content: space-between; padding: 5px; background: var(--table-bg); border-top: 1px solid var(--border); color: var(--text-color); }

        /* --- PRINTABLE PAGE WRAPPER --- */
        .printable-page { display: none; width: 100%; background: white; color: #000; }
        .slip-container { width: 100%; display: flex; flex-direction: row; height: 100vh; page-break-after: always; overflow: hidden; }
        .slip-half { width: 50%; padding: 0.3in; box-sizing: border-box; position: relative; display: flex; flex-direction: column; height: 100%; }
        .perforated-line { position: absolute; right: 0; top: 2%; bottom: 2%; border-right: 1.5px dashed #000000; }
        .slip-row { display: flex; align-items: flex-end; margin-bottom: 6px; width: 100%; }
        .label { font-weight: bold; text-transform: uppercase; margin-right: 8px; font-size: 0.7em; white-space: nowrap; }
        .underline { border-bottom: 1px solid #000; flex-grow: 1; min-height: 1.1em; padding-left: 5px; font-family: "Courier New", monospace; font-weight: bold; font-size: 0.95em; }
        .med-details-print { font-size: 0.75em !important; font-weight: normal; }
        .billing-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .billing-table th, .billing-table td { border: 1px solid #000; height: 24px; text-align: center; font-size: 0.8em; color: #000; background: #fff; }
        .notes-area { flex-grow: 1; border: 1px solid #000; margin-top: 10px; padding: 5px; position: relative; min-height: 40px; }
        .log-row-single { display: flex; width: 100%; margin-top: 8px; font-size: 0.6em; font-weight: bold; align-items: flex-end; }
        .log-underline { border-bottom: 1px solid #000; flex-grow: 1; height: 1.2em; margin-left: 4px; }

        /* Patient Form Print Styles */
        #patientPrintSheet { display: none; width: 100%; height: 100vh; padding: 0.5in; box-sizing: border-box; page-break-before: always; font-family: "Inter", sans-serif; color: #000000; }
        .pt-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
        .pt-title { font-size: 1.25rem; font-weight: 800; text-transform: uppercase; line-height: 1; }
        .pt-subtitle { font-size: 0.65rem; color: #6b7280; font-style: italic; }
        .pt-section-header { font-size: 0.75rem; font-weight: 800; color: #111827; text-transform: uppercase; letter-spacing: 0.05em; background-color: #f3f4f6; padding: 0.25rem 0.5rem; margin-bottom: 0.75rem; border-left: 4px solid #2563eb; }
        .pt-grid-12 { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 0.75rem; }
        .pt-col-1 { grid-column: span 1; } .pt-col-2 { grid-column: span 2; } .pt-col-3 { grid-column: span 3; }
        .pt-col-4 { grid-column: span 4; } .pt-col-5 { grid-column: span 5; } .pt-col-6 { grid-column: span 6; } .pt-col-12 { grid-column: span 12; }
        .pt-label { font-size: 0.65rem; font-weight: 700; color: #4b5563; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .pt-input { border-bottom: 1px solid #d1d5db; width: 100%; padding-bottom: 2px; font-size: 0.875rem; font-family: "Courier New", monospace; min-height: 1.2em; }
        .pt-footer { padding-top: 10px; display: flex; gap: 20px; align-items: flex-end; margin-top: 20px; }

        /* Waiver Page Styles */
        #waiverPage { display: none; width: 100%; height: 100vh; padding: 0.75in; box-sizing: border-box; page-break-before: always; }
        .waiver-title { font-size: 1.6em; font-weight: bold; text-align: center; border-bottom: 2px solid #000; margin-bottom: 15px; padding-bottom: 5px; }
        .waiver-full-text p { margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-left: 5px solid var(--primary); font-size: 1.05em; }
        #out-sig-image { height: 70px; border-bottom: 1px solid #000; display: block; margin-bottom: 5px; }

        @media print {
            @page { size: letter landscape; margin: 0; }
            .catalog-container, .sidebar, .action-btn, #loginOverlay, #patientInfoOverlay, #languageModal, #newPtPrompt, #measureModal, .measure-btn { display: none !important; }
            body { background: white; display: block; overflow: visible; }
            .printable-page { display: block !important; }
            #patientPrintSheet.active, #waiverPage.active { display: block !important; }
        }
    </style>
</head>

<body>
			<div id="rotate-overlay">
    <div style="font-size: 60px; margin-bottom: 20px;">ðŸ”„ ðŸ“±</div>
    	<h2>Please Rotate Your Device</h2>
    	<p>P.O.S.T. requires landscape orientation to display the workbench properly.</p>
			</div>

    <div id="measureModal">
        <div class="measure-content">
            <span class="close-measure" onclick="closeMeasureTool()">&times;</span>
            <h3 style="color:black;">Camera Measurement Tool</h3>
            
            <div id="cam-step-1">
                <p>1. Ensure A-Measurement is entered correctly (Frame Specs).<br>
                   2. Hold camera level with patient's face.<br>
                   3. If using a file, upload below.</p>
                <div class="cam-controls">
                    <button class="cam-btn btn-start" onclick="startCamera()">Start Camera</button>
                    <input type="file" id="imageLoader" accept="image/*" style="display:none">
                    <button class="cam-btn btn-snap" onclick="document.getElementById('imageLoader').click()">Upload Photo</button>
                </div>
            </div>

            <video id="videoElement" autoplay playsinline></video>
            
            <div class="cam-controls" id="snap-controls" style="display:none;">
                <button class="cam-btn btn-snap" onclick="takeSnapshot()">TAKE PHOTO</button>
            </div>

            <div id="measure-ui" style="display:none;">
                <div id="measure-instruction" class="instruction-banner">Click Left Edge of Lens</div>
                <div style="overflow:auto; max-height: 50vh;">
                     <canvas id="photoCanvas"></canvas>
                </div>
                
                <div class="cam-controls">
                    <button class="cam-btn btn-reset" onclick="resetMeasurement()">Reset</button>
                    <button class="cam-btn btn-save-measure" onclick="saveMeasurements()">SAVE MEASUREMENTS</button>
                </div>
                <div style="margin-top:10px; font-weight:bold;">
                    PD: <span id="calc-pd">--</span> | Seg: <span id="calc-seg">--</span>
                </div>
            </div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>P.O.S.T. Login</h2>
            <input type="text" id="userIn" placeholder="FIRST NAME" />
            <input type="password" id="passIn" placeholder="PASSWORD" />
            <button class="login-btn" onclick="attemptLogin()">Login</button>
            <p id="loginError" style="color: red; font-size: 0.8em; display: none; margin-top: 10px">
                FAILED ATTEMPT 1 OUT OF 3. IF 3 ATTEMPS DEVICE WILL SHUT DOWN
            </p>
        </div>
    </div>

    <div id="newPtPrompt">
        <div class="prompt-box">
            <h3 style="margin:0 0 15px 0; color:var(--primary);">Is this a New Patient?</h3>
            <div style="display:flex; justify-content:center;">
                <button class="prompt-btn" style="background:var(--success); color:white;"
                    onclick="confirmNewPatient()">YES<br><span style="font-size:0.7em; font-weight:normal;">(Open
                        Form)</span></button>
                <button class="prompt-btn" style="background:#e74c3c; color:white;"
                    onclick="dismissPrompt()">NO<br><span style="font-size:0.7em; font-weight:normal;">(Existing
                        Pt)</span></button>
            </div>
        </div>
    </div>

    <div id="languageModal">
        <div class="language-box">
            <h2>Select Language</h2>
            <button class="lang-option" onclick="openPtSheet('en')">English</button>
            <button class="lang-option" onclick="openPtSheet('es')">EspaÃ±ol</button>
            <button class="lang-option" onclick="openPtSheet('fr')">
                FranÃ§ais
            </button>
            <button class="lang-btn-cancel" onclick="closeLanguageModal()">
                Cancel
            </button>
        </div>
    </div>

    <div id="segHeightModal">
        <div class="seght-box">
            <h2>Pre Adjustment</h2>
            <div class="message">PRE ADJUSTMENT DONE?</div>
            <div class="seght-btn-group">
                <button class="seght-btn seght-btn-yes" onclick="handleSegHeightYes()">
                    YES
                </button>
                <button class="seght-btn seght-btn-no" onclick="handleSegHeightNo()">
                    NO
                </button>
            </div>
            <div class="seght-warning" id="seght-warning">
                PLEASE PRE-ADJUST FRAME TO ENSURE PROPER SEG HEIGHT
            </div>
        </div>
    </div>

    <div id="remakeModal">
        <div class="remake-box">
            <h2>REMAKE</h2>
            <label for="remake-reason">Why is this a remake?</label>
            <textarea id="remake-reason" placeholder="Enter reason for remake..."></textarea>
            <div class="remake-btn-group">
                <button class="remake-btn remake-btn-cancel" onclick="closeRemakeModal()">
                    Cancel
                </button>
                <button class="remake-btn remake-btn-save" onclick="saveRemakeReason()">
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="patientInfoOverlay">
        <div class="info-sheet-container">
            <h2 id="lbl-new-pt">New Patient Information</h2>

            <div class="overlay-section">
                <div class="overlay-row">
                    <div style="flex: 2">
                        <label class="overlay-label" id="lbl-name">Full Name</label><input type="text" id="in-pt-name"
                            class="overlay-input" oninput="syncPtName()" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-dob">DOB</label><input type="date" id="in-pt-dob"
                            class="overlay-input" onchange="checkMinor()" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-gender">Gender</label><select id="in-pt-gender"
                            class="overlay-input">
                            <option>M</option>
                            <option>F</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <div class="overlay-row">
                    <div style="flex: 2">
                        <label class="overlay-label" id="lbl-address">Street Address</label><input type="text"
                            id="in-pt-address" class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-city">City</label><input type="text" id="in-pt-city"
                            class="overlay-input" />
                    </div>
                    <div style="flex: 0.5">
                        <label class="overlay-label" id="lbl-state">State</label><input type="text" id="in-pt-state"
                            class="overlay-input" />
                    </div>
                    <div style="flex: 0.8">
                        <label class="overlay-label" id="lbl-zip">Zip</label><input type="text" id="in-pt-zip"
                            class="overlay-input" />
                    </div>
                </div>
                <div class="overlay-row">
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-ssn">SSN</label><input type="text" id="in-pt-ssn"
                            class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-phone">Phone</label><input type="text" id="in-pt-phone"
                            class="overlay-input" placeholder="(XXX) XXX-XXXX" oninput="formatPhoneNumber(this)"
                            maxlength="14" />
                    </div>
                    <div style="flex: 1.5">
                        <label class="overlay-label" id="lbl-email">Email</label><input type="text" id="in-pt-email"
                            class="overlay-input" />
                    </div>
                </div>
            </div>

            <div id="guardianSection" style="
            display: none;
            border: 2px dashed #d35400;
            padding: 12px;
            margin: 10px 0;
            background-color: #fffaf0;
          ">
                <label style="
              color: #d35400;
              font-size: 0.8rem;
              font-weight: 900;
              display: block;
              margin-bottom: 8px;
            " id="lbl-guard-header">PARENT/GUARDIAN INFO (REQUIRED FOR MINORS)</label>
                <div class="overlay-row">
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-guard-name">Guardian Name</label><input type="text"
                            id="in-pt-guard-name" class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-guard-phone">Phone</label><input type="tel"
                            id="in-pt-guard-phone" class="overlay-input" placeholder="(XXX) XXX-XXXX"
                            oninput="formatPhoneNumber(this)" maxlength="14" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-guard-rel">Relationship</label><input type="text"
                            id="in-pt-guard-rel" class="overlay-input" />
                    </div>
                </div>
            </div>

            <div class="overlay-section">
                <label class="overlay-label" style="
              font-size: 0.9rem;
              margin-bottom: 5px;
              border-bottom: 1px solid #eee;
            " id="lbl-ins-header">Insurance</label>
                <div class="overlay-row">
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-ins-name">Primary Ins Name</label><input type="text"
                            id="in-pt-ins-name" class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-ins-id">Member ID</label><input type="text"
                            id="in-pt-ins-id" class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-ins-holder">Policy Holder</label><input type="text"
                            id="in-pt-ins-holder" class="overlay-input" />
                    </div>
                    <div style="flex: 1">
                        <label class="overlay-label" id="lbl-ins-dob">Policy Holder DOB</label><input type="date"
                            id="in-pt-ins-dob" class="overlay-input" />
                    </div>
                </div>
            </div>

            <div class="overlay-section">
                <label class="overlay-label" style="font-size: 0.9rem; margin-bottom: 5px" id="lbl-hipaa-header">HIPAA &
                    Consent</label>
                <div style="display: flex; align-items: center; gap: 10px">
                    <input type="checkbox" id="in-pt-hipaa" style="width: auto" />
                    <label for="in-pt-hipaa" style="font-size: 0.85rem" id="lbl-hipaa-text">I acknowledge I have
                        received/reviewed the Notice of Privacy
                        Practices (HIPAA).</label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px">
                <button class="action-btn" style="background: var(--success)" onclick="closePtForm(true)" id="btn-save">
                    SAVE & ATTACH
                </button>
                <button class="action-btn" style="background: #e74c3c" onclick="closePtForm(false)" id="btn-cancel">
                    CANCEL
                </button>
            </div>
        </div>
    </div>

    <div class="catalog-container">
        <input type="text" class="search-box" id="searchInput" placeholder="Search Lenses and Options..." />
        <div class="category-buttons" id="categoryNav"></div>
        <div id="lensContainer" class="lens-grid"></div>

        <div class="history-section">
            <h3>Recent Shop Activity (Click Row to Reload)</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Job #</th>
                        <th>Optician</th>
                        <th>Patient</th>
                        <th>Plan</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-branding">
            <h1>P.O.S.T.</h1>
            <p>Pal Optical Slip Tool</p>
            <label class="switch theme-toggle">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider"></span>
            </label>
        </div>

        <button class="action-btn" style="background: var(--primary); margin-bottom: 10px" onclick="
          document.getElementById('languageModal').style.display = 'flex'
        ">
            + NEW PATIENT INFO SHEET
        </button>
        <button id="printBtn" class="action-btn" onclick="printJob()">
            PRINT ALL DOCUMENTS & SYNC
        </button>
        <div id="validationMessage" class="validation-message"></div>

        <div class="input-row" style="
          background: #ffffff;
          padding: 10px;
          border-radius: 4px;
          border: 1px solid #000;
        ">
            <div style="flex: 1">
                <label style="font-size: 0.7em; font-weight: bold; display: block">WRITE-UP #</label>
                <input type="number" id="in-job-num" readonly
                    style="background: #fdfdfd; font-weight: bold; color: red" />
            </div>
            <div style="flex: 1">
                <label style="font-size: 0.7em; font-weight: bold; display: block">LOGGED IN AS</label>
                <input type="text" id="in-optician" readonly
                    style="background: #ffffff; font-weight: bold; text-align: center" />
            </div>
        </div>

        <div id="job-type-section" style="background: var(--table-bg); padding: 8px; border-radius: 4px; border: 1px solid var(--border); margin: 8px 0; font-size: 0.85em;">
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-around; font-weight: bold;">
                <label style="cursor:pointer;"><input type="checkbox" id="job-type-complete" onchange="handleJobTypeChange('complete')"> Complete</label>
                <label style="cursor:pointer;"><input type="checkbox" id="job-type-frame" onchange="handleJobTypeChange('frame')"> Frame Only</label>
                <label style="cursor:pointer;"><input type="checkbox" id="job-type-lens" onchange="handleJobTypeChange('lens')"> Lens Only</label>
            </div>
        </div>


        <h3>Plan & Patient</h3>
        <select id="insuranceSelect" onchange="handleInsuranceChange()" style="margin-bottom: 8px">
            <option value="None">Private Pay / None</option>
            <option value="MEDICAID">MEDICAID</option>
            <option value="EYE-MED">EYE-MED</option>
            <option value="AETNA EYE-MED">AETNA EYE-MED</option>
            <option value="PREMIER VISION">PREMIER VISION</option>
            <option value="MARCH/EYESYNERGY">MARCH/EYESYNERGY</option>
            <option value="UNUM">UNUM</option>
            <option value="NVA">NVA</option>
            <option value="VBA">VBA</option>
            <option value="VSP">VSP</option>
            <option value="SPECTERA">SPECTERA</option>
            <option value="SCHOOL LETTER">SCHOOL LETTER</option>
        </select>

        <div id="medicaid-sub-box" class="medicaid-options">
            <label style="font-size: 0.7em; font-weight: bold">MEDICAID TYPE</label>
            <select id="medicaid-type" onchange="updateSlip()" style="margin-bottom: 5px">
                <option value="Aetna">Aetna</option>
                <option value="Humana/Eyequest">Humana/Eyequest</option>
                <option value="Regular">Regular</option>
                <option value="Wellcare">Wellcare</option>
            </select>
            <label style="font-size: 0.7em; font-weight: bold">BILLING CODE / AUTH</label>
            <select id="medicaid-code" onchange="updateSlip()">
                <option value="92340">92340</option>
                <option value="92370">92370</option>
                <option value="Prior Auth">Prior Auth</option>
            </select>
        </div>

        <div id="school-sub-box" class="school-options">
            <label style="font-size: 0.7em; font-weight: bold">SCHOOL SEARCH (LEXINGTON, KY)</label>
            <input type="text" id="in-school-name" list="lex-schools" placeholder="Start typing school name..."
                oninput="updateSlip()" />
            <datalist id="lex-schools">
                <option value="Arlington Elementary"></option>
                <option value="Ashland Elementary"></option>
                <option value="Athens-Chilesburg Elementary"></option>
                <option value="Booker T. Washington Elementary"></option>
                <option value="Breckinridge Elementary"></option>
                <option value="Brenda Cowan Elementary"></option>
                <option value="Cardinal Valley Elementary"></option>
                <option value="Cassidy Elementary"></option>
                <option value="Clays Mill Elementary"></option>
                <option value="Coventry Oak Elementary"></option>
                <option value="Deep Springs Elementary"></option>
                <option value="Dixie Magnet Elementary"></option>
                <option value="Garden Springs Elementary"></option>
                <option value="Garrett Morgan Elementary"></option>
                <option value="Glendover Elementary"></option>
                <option value="Harrison Elementary"></option>
                <option value="James Lane Allen Elementary"></option>
                <option value="Julius Marks Elementary"></option>
                <option value="Lansdowne Elementary"></option>
                <option value="Liberty Elementary"></option>
                <option value="Mary Todd Elementary"></option>
                <option value="Maxwell Spanish Immersion Elementary"></option>
                <option value="Meadowthorpe Elementary"></option>
                <option value="Millcreek Elementary"></option>
                <option value="Northern Elementary"></option>
                <option value="Picadome Elementary"></option>
                <option value="Rosa Parks Elementary"></option>
                <option value="Russell Cave Elementary"></option>
                <option value="Sandersville Elementary"></option>
                <option value="Southern Elementary"></option>
                <option value="Squires Elementary"></option>
                <option value="Stonewall Elementary"></option>
                <option value="Tates Creek Elementary"></option>
                <option value="Veterans Park Elementary"></option>
                <option value="Wellington Elementary"></option>
                <option value="William Wells Brown Elementary"></option>
                <option value="Yates Elementary"></option>
                <option value="Beaumont Middle"></option>
                <option value="Bryan Station Middle"></option>
                <option value="Crawford Middle"></option>
                <option value="Edythe J. Hayes Middle"></option>
                <option value="Jessie Clark Middle"></option>
                <option value="Leestown Middle"></option>
                <option value="Lexington Traditional Magnet Middle (LTMS)"></option>
                <option value="Morton Middle"></option>
                <option value="Southern Middle"></option>
                <option value="Tates Creek Middle"></option>
                <option value="Winburn Middle"></option>
                <option value="SCAPA at Bluegrass"></option>
            </datalist>
        </div>

        <input type="text" id="in-name" placeholder="Patient Name (Last,First)" oninput="updateSlip()"
            onblur="checkNewPatientPrompt()" /><input type="tel" id="pt-phone" placeholder="Phone Number"
            oninput="formatPhoneNumber(this); updateSlip();" maxlength="14" />

        <h3>Frame & Measurements</h3>
        <div class="input-row">
            <input type="text" id="in-frame" placeholder="Frame Name & Color" oninput="updateSlip()" style="flex: 2" />
            <div style="flex: 0.5">
                <label style="font-size: 0.65em">A (EYESIZE)</label><input type="number" id="in-frame-a"
                    oninput="updateSlip()" />
            </div>
            <div style="flex: 0.5">
                <label style="font-size: 0.65em">DBL (BRIDGE)</label><input type="number" id="in-frame-dbl"
                    oninput="updateSlip()" />
            </div>
        </div>
        <div class="input-row">
            <div style="flex: 1; display:flex; align-items: center; gap: 5px;">
                <input type="text" id="in-pd" placeholder="P.D." oninput="updateSlip()" style="flex:1;" />
                <button class="measure-btn" onclick="openMeasurementTool()" title="Camera Measure">ðŸ“·</button>
            </div>
            <div style="flex: 1; display:flex; align-items: center; gap: 5px;">
                <input type="text" id="in-seght" placeholder="Seg Height" oninput="updateSlip()"
                    onfocus="showSegHeightModal()" style="flex:1;" />
                <button class="measure-btn" onclick="openMeasurementTool()" title="Camera Measure">ðŸ“·</button>
            </div>
        </div>

        <div class="color-section">
            <span>Color: </span>
            <label><input type="checkbox" id="color-clear" onchange="handleColorChoice('clear')" />
                Clear</label>
            <label><input type="checkbox" id="color-tint" onchange="handleColorChoice('tint')" />
                Tint</label>
            <label><input type="checkbox" id="color-polar" onchange="handleColorChoice('polar')" />
                Polar</label>
            <label><input type="checkbox" id="color-mirror" onchange="handleColorChoice('mirror')" />
                Mirror Coat</label>
            <label><input type="checkbox" id="color-Transitions" onchange="handleColorChoice('Transitions')" />
                Transitions</label>
            <input type="hidden" id="chosen-color-text" />
        </div>

        <h3>Time Promised</h3>
        <div id="time-promised-section" style="background: var(--table-bg); padding: 8px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 8px; font-size: 0.85em;">
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <label><input type="checkbox" id="promise-call" onchange="updateSlip()"> Call</label>
                <label><input type="checkbox" id="promise-text" onchange="updateSlip()"> Text</label>
                <label><input type="checkbox" id="promise-mail" onchange="updateSlip()"> Mail</label>
                <label><input type="checkbox" id="promise-time" onchange="toggleTimeInput()"> Time</label>
                <input type="text" id="promise-time-input" style="display: none; width: 120px; padding: 4px; font-size: 0.9em;" placeholder="e.g. 5:00 PM" oninput="updateSlip()">
            </div>
        </div>

        <h3>Billing Table</h3>
        <table class="bill-ui-table">
            <thead>
                <tr>
                    <th style="text-align: left">Item</th>
                    <th>Retail</th>
                    <th>Retail + Tax</th>
                    <th>Pt Owe</th>
                </tr>
            </thead>
            <tbody>
                <tr data-row="frame">
                    <td><b>FRAME</b></td>
                    <td>
                        <input type="number" step="0.01" class="ret" id="frameRetail"
                            onchange="triggerFrameAllowance()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
                <tr data-row="lens">
                    <td><b id="ui-lens-name">LENS</b></td>
                    <td>
                        <input type="number" step="0.01" class="ret" oninput="calcRow()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
                <tr data-row="coat">
                    <td><b>A/R COATING</b></td>
                    <td>
                        <input type="number" step="0.01" class="ret" oninput="calcRow()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
                <tr data-row="m1">
                    <td>
                        <input type="text" placeholder="Misc 1..." class="m-desc" oninput="updateSlip()" />
                    </td>
                    <td>
                        <input type="number" step="0.01" class="ret" oninput="calcRow()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
                <tr data-row="m2">
                    <td>
                        <input type="text" placeholder="Misc 2..." class="m-desc" oninput="updateSlip()" />
                    </td>
                    <td>
                        <input type="number" step="0.01" class="ret" oninput="calcRow()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
                <tr data-row="m3">
                    <td>
                        <input type="text" placeholder="Misc 3..." class="m-desc" id="misc-3-label"
                            oninput="updateSlip()" />
                    </td>
                    <td>
                        <input type="number" step="0.01" class="ret" id="misc-3-price" oninput="calcRow()" />
                    </td>
                    <td class="tax">0.00</td>
                    <td class="owe" contenteditable="true" oninput="updateSlip()">
                        0.00
                    </td>
                </tr>
            </tbody>
        </table>

        <div style="
          font-weight: bold;
          color: var(--primary);
          font-size: 1.1em;
          text-align: right;
          margin-top: 10px;
        " id="ui-bal">
            Total Owe: $0.00
        </div>

        <h3 id="pay-title" style="display: none">Payment Method</h3>
        <div class="payment-box" id="pay-box">
            <div class="pay-row">
                <label><input type="checkbox" class="pay-check" id="pay-cash" onchange="updateSlip()" />
                    CASH</label>
                <label style="display: flex; align-items: center; gap: 5px">
                    <input type="checkbox" class="pay-check" id="pay-check" onchange="toggleCheckInput()" />
                    CHECK #
                    <span id="check-input-area"><input type="text" id="check-num" style="width: 60px; padding: 2px"
                            oninput="updateSlip()" /></span>
                </label>
            </div>
            <div class="pay-row">
                <label><input type="checkbox" class="pay-check" id="pay-card" onchange="toggleCardOptions()" />
                    CARD</label>
            </div>
            <div class="card-sub-options" id="card-types">
                <label><input type="checkbox" class="card-sub" onchange="updateSlip()" />
                    Visa</label>
                <label><input type="checkbox" class="card-sub" onchange="updateSlip()" />
                    MC</label>
                <label><input type="checkbox" class="card-sub" onchange="updateSlip()" />
                    Discover</label>
                <label><input type="checkbox" class="card-sub" onchange="updateSlip()" />
                    AMEX</label>
                <label><input type="checkbox" class="card-sub" onchange="updateSlip()" />
                    HSA/FSA</label>
            </div>
        </div>

        <h3>Doctor & Eyeglass Prescription</h3>
        <div style="margin-bottom: 8px;">
            <select id="dr-select" onchange="handleDoctorChange()" class="sidebar-select" style="margin-bottom: 5px;">
                <option value="">Select Doctor...</option>
                <option value="Dr. Steven Klecker">Dr. Steven Klecker</option>
                <option value="Dr. Kathryn Robbins">Dr. Kathryn Robbins</option>
                <option value="Other">Other (Type Name)</option>
            </select>
            <input type="text" id="in-dr" placeholder="Type Doctor Name Here..." oninput="updateSlip()"
                style="display:none;">
        </div>

        <table class="rx-ui-table">
            <thead>
                <tr>
                    <th></th>
                    <th>SPH</th>
                    <th>CYL</th>
                    <th>AXIS</th>
                    <th>ADD</th>
                    <th style="width: 80px">PRISM</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><b>OD</b></td>
                    <td><input type="text" id="rx-od-sph" oninput="updateSlip()" /></td>
                    <td><input type="text" id="rx-od-cyl" oninput="updateSlip()" /></td>
                    <td>
                        <input type="text" id="rx-od-axis" oninput="updateSlip()" />
                    </td>
                    <td><input type="text" id="rx-od-add" oninput="updateSlip()" /></td>
                    <td>
                        <input type="text" id="rx-od-prism" oninput="updateSlip()" />
                    </td>
                </tr>
                <tr>
                    <td><b>OS</b></td>
                    <td><input type="text" id="rx-os-sph" oninput="updateSlip()" /></td>
                    <td><input type="text" id="rx-os-cyl" oninput="updateSlip()" /></td>
                    <td>
                        <input type="text" id="rx-os-axis" oninput="updateSlip()" />
                    </td>
                    <td><input type="text" id="rx-os-add" oninput="updateSlip()" /></td>
                    <td>
                        <input type="text" id="rx-os-prism" oninput="updateSlip()" />
                    </td>
                </tr>
            </tbody>
        </table>

        <h3>Bypasses & Waivers</h3>
        <div style="
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 5px;
          background: var(--bypasses-bg);
          padding: 5px;
          border-radius: 4px;
          font-size: 0.75em;
          font-weight: bold;
        ">
            <label><input type="checkbox" id="rx-dvo" onchange="updateSlip()" />
                DVO</label>
            <label><input type="checkbox" id="rx-nvo" onchange="updateSlip()" />
                NVO</label>
            <label><input type="checkbox" id="rx-ivo" onchange="updateSlip()" />
                IVO</label>
            <label><input type="checkbox" id="rx-diff" onchange="handleDiffToggle()" />
                DIFF</label>
        </div>
        <div style="
          background: var(--waiver-bg);
          padding: 8px;
          border-radius: 4px;
          border: 1px solid var(--border);
          font-size: 0.75em;
          font-weight: bold;
          margin-top: 10px;
        ">
            <label class="waiver-row"><input type="checkbox" id="waiver-expired" onchange="updateSlip()" />
                <span>EXPIRED Rx</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-pof" onchange="updateSlip()" />
                <span>PATIENT OWN FRAME</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-thick" onchange="updateSlip()" />
                <span>FRAME THICKNESS</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-poly" onchange="updateSlip()" />
                <span>CHILD NOT IN POLY</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-noline" onchange="updateSlip()" />
                <span>LINED TO NO-LINE</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-semirim" onchange="updateSlip()" />
                <span>SEMI-RIMLESS IN PLASTIC</span></label>
            <label class="waiver-row"><input type="checkbox" id="waiver-remake" onclick="handleRemakeClick()" />
                <span>REMAKE</span></label>
        </div>

        <div class="sig-pad-container">
            <div style="font-size: 0.7em; font-weight: bold; padding: 5px; color: #666">
                PATIENT SIGNATURE
            </div>
            <canvas id="sig-canvas"></canvas>
            <div class="sig-tools">
                <button onclick="clearSig()" style="font-size: 0.7em; cursor: pointer">
                    Clear
                </button>
                <span style="font-size: 0.6em; color: #999">Sign with Finger</span>
            </div>
        </div>

        <button class="action-btn" style="background: #e67e22" onclick="resetForm()">
            Reset Form
        </button>
    </div>

    <div class="printable-page">
        <div class="slip-container" id="dual-slips">
            <div class="slip-half" id="half-1">
                <div class="perforated-line"></div>
                <div class="slip-content" style="display: contents"></div>
            </div>
            <div class="slip-half" id="half-2">
                <div class="slip-content" style="display: contents"></div>
            </div>
        </div>

        <div id="waiverPage">
            <div class="waiver-title">PATIENT DISCLOSURE & WAIVER FORM</div>
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 20px">
                Patient: <span class="out-name"></span> | Date:
                <span class="out-date"></span> | Job:
                <span class="out-job-num"></span>
            </div>
            <div class="waiver-full-text" id="waiverTextDisplay"></div>
            <div style="margin-top: 50px">
                <img id="out-sig-image" src alt="Signature" />
                <div style="
              display: flex;
              justify-content: space-between;
              font-weight: bold;
              border-top: 2px solid #000;
              padding-top: 5px;
            ">
                    <span>Patient Signature (Electronically Captured)</span>
                    <span>Date: <span class="out-date"></span></span>
                </div>
            </div>
        </div>

        <div id="patientPrintSheet">
            <div class="pt-header">
                <div>
                    <h1 class="pt-title">PATIENT INFORMATION</h1>
                </div>
                <p class="pt-subtitle">Please print clearly.</p>
            </div>

            <div class="pt-section-header">Patient Details</div>
            <div class="pt-grid-12">
                <div class="pt-col-6">
                    <label class="pt-label">Patient Name (Last, First, MI)</label>
                    <div class="pt-field" id="out-pt-name"></div>
                </div>
                <div class="pt-col-3">
                    <label class="pt-label">Date of Birth</label>
                    <div class="pt-field" id="out-pt-dob"></div>
                </div>
                <div class="pt-col-3">
                    <label class="pt-label">Gender</label>
                    <div class="pt-field" id="out-pt-gender"></div>
                </div>
            </div>
            <div class="pt-grid-12">
                <div class="pt-col-5">
                    <label class="pt-label">Street Address</label>
                    <div class="pt-field" id="out-pt-address"></div>
                </div>
                <div class="pt-col-4">
                    <label class="pt-label">City</label>
                    <div class="pt-field" id="out-pt-city"></div>
                </div>
                <div class="pt-col-1">
                    <label class="pt-label">State</label>
                    <div class="pt-field" id="out-pt-state"></div>
                </div>
                <div class="pt-col-2">
                    <label class="pt-label">Zip</label>
                    <div class="pt-field" id="out-pt-zip"></div>
                </div>
            </div>
            <div class="pt-grid-12">
                <div class="pt-col-3">
                    <label class="pt-label">SSN</label>
                    <div class="pt-field" id="out-pt-ssn"></div>
                </div>
                <div class="pt-col-3">
                    <label class="pt-label">Phone</label>
                    <div class="pt-field" id="out-pt-phone"></div>
                </div>
                <div class="pt-col-6">
                    <label class="pt-label">Email</label>
                    <div class="pt-field" id="out-pt-email"></div>
                </div>
            </div>

            <div class="pt-section-header">Insurance Information</div>
            <div class="pt-grid-12">
                <div class="pt-col-4">
                    <label class="pt-label">Primary Insurance Name</label>
                    <div class="pt-field" id="out-pt-ins-name"></div>
                </div>
                <div class="pt-col-3">
                    <label class="pt-label">Member ID #</label>
                    <div class="pt-field" id="out-pt-ins-id"></div>
                </div>
                <div class="pt-col-5">
                    <label class="pt-label">Policyholder/Employer</label>
                    <div class="pt-field" id="out-pt-ins-holder"></div>
                </div>
            </div>

            <div class="pt-section-header">HIPAA & Consent</div>
            <p style="font-size: 0.75rem; margin-bottom: 20px">
                I acknowledge I have received and reviewed the Notice of Privacy
                Practices (HIPAA) and authorize treatment.
            </p>

            <div class="pt-footer">
                <div style="flex: 3">
                    <div style="border-bottom: 2px solid #000; margin-bottom: 5px"></div>
                    <label class="pt-label">Patient / Guardian Signature</label>
                </div>
                <div style="flex: 1">
                    <div style="border-bottom: 2px solid #000; margin-bottom: 5px"></div>
                    <label class="pt-label">Date</label>
                </div>
            </div>
        </div>
    </div>

    <div id="jobSlipTemplate" style="display: none">
        <div class="print-branding">
            <h2>P.O.S.T.</h2>
            <p>Pal Optical Slip Tool</p>
        </div>

        <div class="slip-header">
            <div class="opt-initials out-optician">__</div>
            <div class="out-job-num">31599</div>
        </div>
        <div class="slip-row">
            <span class="label">Date</span>
            <div class="underline out-date"></div>
        </div>
        <div class="slip-row">
            <span class="label">Name</span>
            <div class="underline out-name"></div>
        </div>
        <div class="slip-row out-remake-row" style="display: none;">
            <span class="label" style="color: red; font-weight: bold;">REMAKE</span>
            <div class="underline out-remake-reason" style="color: red; font-weight: bold;"></div>
        </div>

        <div class="slip-row">
            <span class="label">Frame</span>
            <div class="underline" style="flex: 2">
                <span class="out-frame"></span> (A:
                <span class="out-frame-a"></span> DBL:
                <span class="out-frame-dbl"></span>)
            </div>
        </div>
        <div class="slip-row">
            <span class="label">P.D.</span>
            <div class="underline out-pd" style="flex: 0.3"></div>
            <span class="label" style="margin-left: 5px">SEG</span>
            <div class="underline out-seght" style="flex: 0.3"></div>
            <span class="label" style="margin-left: 5px">Color</span>
            <div class="underline out-color" style="flex: 1"></div>
        </div>
        <div class="slip-row">
            <span class="label">Lens</span>
            <div class="underline out-full-lens-name"></div>
        </div>

        <table class="billing-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Retail</th>
                    <th>+Tax</th>
                    <th>Pt Owe</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>FRAME</td>
                    <td class="out-ret-frame"></td>
                    <td class="out-tax-frame"></td>
                    <td class="out-owe-frame"></td>
                </tr>
                <tr>
                    <td>LENS</td>
                    <td class="out-ret-lens"></td>
                    <td class="out-tax-lens"></td>
                    <td class="out-owe-lens"></td>
                </tr>
                <tr>
                    <td>A/R COATING</td>
                    <td class="out-ret-coat"></td>
                    <td class="out-tax-coat"></td>
                    <td class="out-owe-coat"></td>
                </tr>
                <tr>
                    <td class="out-m1-name">MISC 1</td>
                    <td class="out-ret-m1"></td>
                    <td class="out-tax-m1"></td>
                    <td class="out-owe-m1"></td>
                </tr>
                <tr>
                    <td class="out-m2-name">MISC 2</td>
                    <td class="out-ret-m2"></td>
                    <td class="out-tax-m2"></td>
                    <td class="out-owe-m2"></td>
                </tr>
                <tr>
                    <td class="out-m3-name">MISC 3</td>
                    <td class="out-ret-m3"></td>
                    <td class="out-tax-m3"></td>
                    <td class="out-owe-m3"></td>
                </tr>
            </tbody>
        </table>

        <div class="slip-row">
            <span class="label">PLAN</span>
            <div class="underline out-ins-full"></div>
        </div>

        <div class="slip-row">
            <span class="label">PROMISED</span>
            <div class="underline out-promised"></div>
        </div>

        <div class="slip-row" style="
          justify-content: space-between;
          font-weight: bold;
          margin-top: 5px;
          border-top: 1px solid #000;
          padding-top: 5px;
        ">
            <div style="font-size: 0.7em">
                PAID:
                <span class="out-pay-method" style="text-decoration: underline"></span>
            </div>
            <div>
                <span class="label">TOTAL CHARGES</span><span class="out-total-before"
                    style="margin-right: 15px; border-bottom: 1px solid #000"></span>
                <span class="label">PATIENT OWE</span><span class="out-total-all"
                    style="border: 2px solid #000; padding: 2px 8px; font-size: 1.1em"></span>
            </div>
        </div>

        <div class="slip-row" style="margin-top: 5px">
            <span class="label">Doctor</span>
            <div class="underline out-dr"></div>
        </div>
        <table class="rx-print-table">
            <thead>
                <tr>
                    <th>Rx</th>
                    <th>SPH</th>
                    <th>CYL</th>
                    <th>AXIS</th>
                    <th>ADD</th>
                    <th>PRISM</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>OD</td>
                    <td class="out-rx-od-sph"></td>
                    <td class="out-rx-od-cyl"></td>
                    <td class="out-rx-od-axis"></td>
                    <td class="out-rx-od-add"></td>
                    <td class="out-rx-od-prism"></td>
                </tr>
                <tr>
                    <td>OS</td>
                    <td class="out-rx-os-sph"></td>
                    <td class="out-rx-os-cyl"></td>
                    <td class="out-rx-os-axis"></td>
                    <td class="out-rx-os-add"></td>
                    <td class="out-rx-os-prism"></td>
                </tr>
            </tbody>
        </table>

        <div class="notes-area">
            <span class="label" style="border-bottom: 1px solid #000; display: block">LAB NOTES:</span>
        </div>

        <div class="log-row-single">
            <span>NOTIFIED BY:</span>
            <div class="log-underline"></div>
            <span style="margin-left: 15px">DISP. BY:</span>
            <div class="log-underline"></div>
        </div>
    </div>

    <script>
        // --- CAMERA MEASUREMENT LOGIC (CREDIT CARD METHOD) ---
        // --- CAMERA MEASUREMENT LOGIC (CREDIT CARD METHOD) ---
        const video = document.getElementById('videoElement');
        const photoCanvas = document.getElementById('photoCanvas');
        const photoCtx = photoCanvas.getContext('2d');
        const imageLoader = document.getElementById('imageLoader');
        let measureStream = null;
        let measureState = 0; // 0:Idle, 1:CardLeft, 2:CardRight, 3:PupilR, 4:PupilL, 5:Seg
        let measurePoints = {};
        let measurePixelsPerMM = 0;
        let measuredPD = 0;
        let measuredSeg = 0;
        const CREDIT_CARD_WIDTH_MM = 85.60; // ISO Standard ID-1 Size

        function openMeasurementTool() {
             // No need to check Frame A anymore since we use the card
             document.getElementById('measureModal').style.display = 'flex';
        }

        function closeMeasureTool() {
            stopCamera();
            document.getElementById('measureModal').style.display = 'none';
        }

        async function startCamera() {
            try {
                // Prefer rear camera if available
                measureStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = measureStream;
                video.style.display = 'block';
                document.getElementById('cam-step-1').style.display = 'none';
                document.getElementById('snap-controls').style.display = 'flex';
            } catch (err) {
                alert("Error accessing camera: " + err);
            }
        }

        function stopCamera() {
            if (measureStream) {
                measureStream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
            }
        }
        
        // Handle File Upload
        imageLoader.addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    prepareCanvas(img);
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }, false);

        function takeSnapshot() {
            prepareCanvas(video);
            stopCamera();
            document.getElementById('snap-controls').style.display = 'none';
        }
        
        function prepareCanvas(source) {
            photoCanvas.width = (source.videoWidth || source.width);
            photoCanvas.height = (source.videoHeight || source.height);
            
            // Limit canvas size if image is massive (for performance)
            if(photoCanvas.width > 1200) {
                 const scale = 1200 / photoCanvas.width;
                 photoCanvas.width = 1200;
                 photoCanvas.height = photoCanvas.height * scale;
            }

            photoCtx.drawImage(source, 0, 0, photoCanvas.width, photoCanvas.height);
            
            video.style.display = 'none';
            document.getElementById('cam-step-1').style.display = 'none';
            document.getElementById('measure-ui').style.display = 'block';
            photoCanvas.style.display = 'block';
            startMeasureLogic();
        }

        function startMeasureLogic() {
            measureState = 1;
            measurePoints = {};
            // Updated Instruction
            document.getElementById('measure-instruction').innerText = "Step 1: Click LEFT Edge of the Credit Card";
            document.getElementById('measure-instruction').style.background = "#fff3cd";
        }

        photoCanvas.addEventListener('mousedown', function(e) {
            if (measureState === 0) return;

            const rect = photoCanvas.getBoundingClientRect();
            const scaleX = photoCanvas.width / rect.width;
            const scaleY = photoCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            drawDot(x, y);

            if (measureState === 1) { // Card Left
                measurePoints.cardLeft = {x, y};
                measureState = 2;
                document.getElementById('measure-instruction').innerText = "Step 2: Click RIGHT Edge of the Credit Card";
            } else if (measureState === 2) { // Card Right
                measurePoints.cardRight = {x, y};
                
                // Calculate Scale based on 85.60mm
                const pixDist = Math.hypot(measurePoints.cardRight.x - measurePoints.cardLeft.x, measurePoints.cardRight.y - measurePoints.cardLeft.y);
                
                if(pixDist === 0) {
                    alert("Points are too close. Please try again.");
                    resetMeasurement();
                    return;
                }

                measurePixelsPerMM = pixDist / CREDIT_CARD_WIDTH_MM;

                drawMeasureLine(measurePoints.cardLeft, measurePoints.cardRight, 'blue');
                measureState = 3;
                document.getElementById('measure-instruction').innerText = "Step 3: Click Center of RIGHT Pupil";
                document.getElementById('measure-instruction').style.background = "#d4edda";
            } else if (measureState === 3) { // Pupil R
                measurePoints.pupilR = {x, y};
                measureState = 4;
                document.getElementById('measure-instruction').innerText = "Step 4: Click Center of LEFT Pupil";
            } else if (measureState === 4) { // Pupil L
                measurePoints.pupilL = {x, y};
                
                // Calc PD
                const pdPx = Math.hypot(measurePoints.pupilL.x - measurePoints.pupilR.x, measurePoints.pupilL.y - measurePoints.pupilR.y);
                measuredPD = pdPx / measurePixelsPerMM;
                document.getElementById('calc-pd').innerText = measuredPD.toFixed(1) + "mm";
                
                drawMeasureLine(measurePoints.pupilR, measurePoints.pupilL, 'red');

                measureState = 5;
                document.getElementById('measure-instruction').innerText = "Step 5: Click BOTTOM of Right Lens (Seg Height)";
            } else if (measureState === 5) { // Seg
                measurePoints.seg = {x, y};
                
                // Calc Seg (Vertical distance from Pupil R)
                const segPx = Math.abs(measurePoints.seg.y - measurePoints.pupilR.y);
                measuredSeg = segPx / measurePixelsPerMM;
                document.getElementById('calc-seg').innerText = measuredSeg.toFixed(1) + "mm";

                drawMeasureLine(measurePoints.pupilR, {x: measurePoints.pupilR.x, y: measurePoints.seg.y}, 'orange');
                
                measureState = 6;
                document.getElementById('measure-instruction').innerText = "Done! Click SAVE MEASUREMENTS below.";
                document.getElementById('measure-instruction').style.background = "#cce5ff";
            }
        });

        function drawDot(x, y) {
            photoCtx.fillStyle = 'red';
            photoCtx.beginPath();
            photoCtx.arc(x, y, 5, 0, Math.PI * 2);
            photoCtx.fill();
        }
        function drawMeasureLine(p1, p2, color) {
            photoCtx.strokeStyle = color;
            photoCtx.lineWidth = 3;
            photoCtx.beginPath();
            photoCtx.moveTo(p1.x, p1.y);
            photoCtx.lineTo(p2.x, p2.y);
            photoCtx.stroke();
        }

        function resetMeasurement() {
            photoCtx.clearRect(0,0, photoCanvas.width, photoCanvas.height);
            document.getElementById('measure-ui').style.display = 'none';
            document.getElementById('calc-pd').innerText = "--";
            document.getElementById('calc-seg').innerText = "--";
            startCamera(); 
        }

        function saveMeasurements() {
            if(measuredPD > 0) {
                 document.getElementById('in-pd').value = measuredPD.toFixed(1);
            }
            if(measuredSeg > 0) {
                 allowSegHeightModal = false;
                 document.getElementById('in-seght').value = measuredSeg.toFixed(1);
                 setTimeout(() => { allowSegHeightModal = true; }, 1000);
            }
            closeMeasureTool();
            updateSlip(); 
        }

        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJTOsQZ2rgynHPz3uKv2_VlRsZiYlOId0",
            authDomain: "pal-optical-tool.firebaseapp.com",
            projectId: "pal-optical-tool",
            storageBucket: "pal-optical-tool.firebasestorage.app",
            messagingSenderId: "294632477326",
            appId: "1:294632477326:web:6aca10159254e27a8e2fdf",
            databaseURL: "https://pal-optical-tool-default-rtdb.firebaseio.com/",
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const jobNumRef = database.ref("lastJobNumber");
        const historyRef = database.ref("jobHistory");

        // --- DATA ---
        const USERS = {
            JAMES: { pass: "1945390167", initials: "JB" },
            LINDA: { pass: "BOSS", initials: "LG" },
            APRIL: { pass: "ODIOSUS", initials: "AB" },
            NAEROBI: { pass: "bobi", initials: "NG" },
            SABRINA: { pass: "joeishot", initials: "SJ" },
            TRACY: { pass: "robiscool", initials: "TH" },
            CARRIBYAN: { pass: "car'nayle", initials: "CWR" },
        };

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            en: {
                newPt: "New Patient Information",
                fullName: "Full Name",
                dob: "DOB",
                gender: "Gender",
                address: "Street Address",
                city: "City",
                state: "State",
                zip: "Zip",
                ssn: "SSN",
                phone: "Phone",
                email: "Email",
                guardHeader: "PARENT/GUARDIAN INFO (REQUIRED FOR MINORS)",
                guardName: "Guardian Name",
                guardRel: "Relationship",
                insHeader: "Insurance",
                primIns: "Primary Ins Name",
                memId: "Member ID",
                polHolder: "Policy Holder",
                polDob: "Policy Holder DOB",
                hipaaHeader: "HIPAA & Consent",
                hipaaText:
                    "I acknowledge I have received/reviewed the Notice of Privacy Practices (HIPAA).",
                save: "SAVE & ATTACH",
                cancel: "CANCEL",
            },
            es: {
                newPt: "InformaciÃ³n del Nuevo Paciente",
                fullName: "Nombre Completo",
                dob: "Fecha de Nacimiento",
                gender: "GÃ©nero",
                address: "DirecciÃ³n",
                city: "Ciudad",
                state: "Estado",
                zip: "CÃ³digo Postal",
                ssn: "Seguro Social",
                phone: "TelÃ©fono",
                email: "Correo ElectrÃ³nico",
                guardHeader: "INFO DE PADRE/TUTOR (REQUERIDO PARA MENORES)",
                guardName: "Nombre del Tutor",
                guardRel: "RelaciÃ³n",
                insHeader: "Seguro MÃ©dico",
                primIns: "Nombre del Seguro",
                memId: "NÃºmero de Miembro",
                polHolder: "Titular de la PÃ³liza",
                polDob: "Fecha Nac. del Titular",
                hipaaHeader: "HIPAA y Consentimiento",
                hipaaText:
                    "Reconozco que he recibido/revisado el Aviso de PrÃ¡cticas de Privacidad (HIPAA).",
                save: "GUARDAR Y ADJUNTAR",
                cancel: "CANCELAR",
            },
            fr: {
                newPt: "Informations sur le Nouveau Patient",
                fullName: "Nom Complet",
                dob: "Date de Naissance",
                gender: "Genre",
                address: "Adresse",
                city: "Ville",
                state: "Ã‰tat",
                zip: "Code Postal",
                ssn: "SÃ©curitÃ© Sociale",
                phone: "TÃ©lÃ©phone",
                email: "E-mail",
                guardHeader: "INFO PARENT/TUTEUR (REQUIS POUR MINEURS)",
                guardName: "Nom du Tuteur",
                guardRel: "Relation",
                insHeader: "Assurance",
                primIns: "Nom de l'Assurance",
                memId: "ID Membre",
                polHolder: "Titulaire de la Police",
                polDob: "Date Naissance Titulaire",
                hipaaHeader: "HIPAA et Consentement",
                hipaaText:
                    "Je reconnais avoir reÃ§u/lu l'Avis de Pratiques de ConfidentialitÃ© (HIPAA).",
                save: "ENREGISTRER ET JOINDRE",
                cancel: "ANNULER",
            },
        };

        // --- PRICING DATABASE (FULL) ---
        const MASTER_PRICE_LIST = {
            "Plastic (CR-39)": [
                { name: "Plano", price: 35.0 },
                { name: "Single Vision Plastic", price: 50.0 },
                { name: "Eyezen (+0-+4) PLASTIC PLASTIC", price: 125.0 },
                { name: "Flat Top 28 Bifocal PLASTIC", price: 140.0 },
                { name: "Flat Top 35 Bifocal PLASTIC", price: 145.0 },
                { name: "Trifocal 7x28 PLASTIC", price: 165.0 },
                { name: "RD-22 Round Seg PLASTIC", price: 50.0 },
                { name: "Franklin Seg PLASTIC", price: 500.0 },
                { name: "Essilor Natural PLASTIC", price: 295.0 },
                { name: "Essilor Ovation PLASTIC", price: 350.0 },
                { name: "Varilux Comfort DRx PLASTIC", price: 365.0 },
                { name: "Varilux Physio DRx PLASTIC", price: 390.0 },
                { name: "Varilux X PLASTIC", price: 530.0 },
                { name: "Shamir Autograph III PLASTIC", price: 465.0 },
                { name: "VSP Unity ETHOS PLASTIC", price: 325.0 },
                { name: "VSP Unity VIA PLASTIC", price: 350.0 },
                { name: "VSP Unity VIA Elite PLASTIC", price: 425.0 },
                { name: "Younger Image PLASTIC", price: 255.0 },
            ],
            Polycarbonate: [
                { name: "Single Vision POLY ", price: 115.0 },
                { name: "Eyezen (+0-+4) POLY", price: 180.0 },
                { name: "Essilor Stellest Myopia Control POLY (COMES WITH CRIZAL EASY A/R)", price: 325.0 },
                { name: "Flat Top 28 Bifocal POLY", price: 180.0 },
                { name: "Flat Top 35 Bifocal POLY", price: 240.0 },
                { name: "Trifocal 7x28 POLY", price: 205.0 },
                { name: "Essilor Natural ", price: 335.0 },
                { name: "Essilor Ovation POLY", price: 390.0 },
                { name: "Varilux Comfort DRx POLY", price: 405.0 },
                { name: "Varilux Physio DRx POLY", price: 430.0 },
                { name: "Varilux X POLY", price: 570.0 },
                { name: "Shamir Autograph III POLY", price: 505.0 },
                { name: "VSP Unity ETHOS POLY", price: 365.0 },
                { name: "VSP Unity VIA POLY", price: 410.0 },
                { name: "VSP Unity VIA Elite POLY", price: 465.0 },
                { name: "Younger Image POLY", price: 295.0 },
            ],
            Trivex: [
                { name: "Single Vision TRIVEX ", price: 150.0 },
                { name: "Eyezen (+0-+4)", price: 195.0 },
                { name: "Flat Top 28 Bifocal TRIVEX", price: 205.0 },
                { name: "Trifocal 7x28 TRIVEX", price: 245.0 },
                { name: "Essilor Ovation TRIVEX", price: 315.0 },
                { name: "Varilux Comfort DRx TRIVEX", price: 415.0 },
                { name: "Varilux X TRIVEX", price: 630.0 },
                { name: "Freefocus HD(Luzerne) TRIVEX", price: 305.0 },
                { name: "Younger Image TRIVEX", price: 315.0 },
            ],
            "High-Index": [
                { name: "Single Vision 1.67", price: 365.0 },
                { name: "Single Vision 1.74", price: 400.0 },
                { name: "Eyezen 1.67 (+0-+4)", price: 415.0 },
                { name: "Flat Top 28 Bifocal 1.67", price: 420.0 },
                { name: "Flat Top 35 Bifocal 1.67", price: 450.0 },
                { name: "RD-22 Round Seg 1.67", price: 550.0 },
                { name: "Franklin Seg 1.67", price: 1050.0 },
                { name: "Essilor Natural Digital 1.67", price: 500.0 },
                { name: "Essilor Ovation Digital 1.67", price: 500.0 },
                { name: "Varilux Physio 1.67", price: 625.0 },
                { name: "Varilux X 1.67", price: 825.0 },
                { name: "Shamir Autograph III 1.67", price: 625.0 },
                { name: "VSP Unity V3 1.67", price: 525.0 },
                { name: "VSP Unity Elite 1.67", price: 695.0 },
                { name: "Younger Image 1.67", price: 520.0 },
            ],
            Glass: [
                { name: "Single Vision GLASS", price: 175.0 },
                { name: "FT-28 GLASS", price: 285.0 },
                { name: "7x-28 GLASS", price: 345.0 },
                { name: "Freefocus HD GLASS", price: 500.0 },
                { name: "X-Ray Glass SV GLASS", price: 400.0 },
                { name: "X-Ray Glass FT-28 GLASS", price: 450.0 },
                { name: "X-Ray Glass Prog GLASS", price: 575.0 },
            ],
            "Office/Computer Progressives": [
                { name: "Freefocus PC13/20 PLASTIC", price: 205.0 },
                { name: "Shamir Workspace PLASTIC", price: 245.0 },
                { name: "Zeiss Officelens PLASTIC", price: 225.0 },
            ],
            "Transitions Plastic": [
                { name: "Single Vision TRANS", price: 235.0 },
                { name: "FT-28 TRANS", price: 250.0 },
                { name: "RD-22 TRANS", price: 360.0 },
                { name: "7x28 TRANS", price: 275.0 },
                { name: "Essilor Natural Digital TRANS PLASTIC", price: 415.0 },
                { name: "Varilux Comfort TRANS", price: 475.0 },
                { name: "Varilux Physio TRANS", price: 510.0 },
                { name: "Varilux X TRANS", price: 640.0 },
                { name: "Shamir Auto III TRANS", price: 575.0 },
                { name: "VSP Unity V3 TRANS", price: 435.0 },
                { name: "VSP Unity Elite TRANS", price: 535.0 },
                { name: "Younger Image TRANS", price: 365.0 },
            ],
            "Transitions Poly": [
                { name: "Single Vision TRANS POLY", price: 275.0 },
                { name: "FT-28 TRANS POLY", price: 290.0 },
                { name: "RD-22 TRANS POLY", price: 395.0 },
                { name: "7x28 TRANS POLY", price: 315.0 },
                { name: "Essilor Natural Digital TRANS POLY", price: 455.0 },
                { name: "Varilux Comfort TRANS POLY", price: 505.0 },
                { name: "Varilux Physio TRANS POLY", price: 550.0 },
                { name: "Varilux X TRANS POLY", price: 690.0 },
                { name: "Shamir Auto III TRANS POLY", price: 615.0 },
                { name: "VSP Unity V3 TRANS POLY", price: 475.0 },
                { name: "VSP Unity Elite TRANS POLY", price: 575.0 },
                { name: "Younger Image TRANS POLY", price: 405.0 },
            ],
            "Transitions Trivex": [
                { name: "Single Vision TRANS TRIVEX", price: 275.0 },
                { name: "FT-28 TRANS TRIVEX", price: 300.0 },
                { name: "7x28 TRANS TRIVEX", price: 350.0 },
                { name: "Younger Image TRANS TRIVEX", price: 455.0 },
                { name: "Essilor Ovation Digital TRANS TRIVEX ", price: 570.0 },
                { name: "Varilux Comfort TRANS TRIVEX", price: 650.0 },
                { name: "Varilux X TRANS TRIVEX", price: 790.0 },
                { name: "Freefocus HD TRANS TRIVEX", price: 405.0 },
                { name: "VSP Unity V3 TRANS TRIVEX", price: 590.0 },
            ],
            "Transitions High-Index": [
                { name: "Single Vision 1.67 TRANS", price: 465.0 },
                { name: "Single Vision 1.74 TRANS", price: 650.0 },
                { name: "FT-28 1.67(V Dyna) TRANS", price: 470.0 },
                { name: "RD-22 1.67 TRANS", price: 600.0 },
                { name: "Essilor Natural Digital 1.67 TRANS", price: 650.0 },
                { name: "Varilux Comfort 1.67 TRANS", price: 720.0 },
                { name: "Varilux Physio 1.67 TRANS", price: 750.0 },
                { name: "Varilux X 1.67 TRANS", price: 900.0 },
                { name: "Shamir Auto III 1.67 TRANS", price: 720.0 },
                { name: "VSP Unity V3 1.67 TRANS", price: 650.0 },
                { name: "VSP Unity Elite 1.67 TRANS", price: 800.0 },
            ],
            "PGX/PBX Glass": [
                { name: "Single Vision GLASS PGX/PBX", price: 300.0 },
                { name: "FT-28 GLASS PGX/PBX", price: 410.0 },
                { name: "7x28 GLASS PGX/PBX", price: 475.0 },
                { name: "Freefocus HD GLASS PGX/PBX", price: 590.0 },
            ],
            "Transitions XtraActive Polar(POLY)": [
                { name: "Single Vision TRANS XTRA POLAR", price: 375.0 },
                { name: "Ovation Digital TRANS XTRA POLAR", price: 575.0 },
                { name: "Varilux Comfort DRx TRANS XTRA POLAR", price: 650.0 },
                { name: "Younger Image TRANS XTRA POLAR", price: 525.0 },
            ],
            "Drivewear": [
                { name: "Single Vision DRIVEWEAR POLY", price: 360.0 },
                { name: "Younger Image DRIVEWEAR POLY", price: 500.0 },
            ],
            "Polarized Plastic": [
                { name: "Single Vision POLARIZED", price: 175.0 },
                { name: "KBCO Single Vision POLARIZED", price: 250.0 },
                { name: "FT-28 POLARIZED", price: 225.0 },
                { name: "KBCO FT-28 POLARIZED", price: 300.0 },
                { name: "7x28 POLARIZED", price: 270.0 },
                { name: "KBCO 7x28 POLARIZED", price: 350.0 },
                { name: "Essilor Natural POLARIZED", price: 450.0 },
                { name: "KBCO IRx Pro POLARIZED", price: 475.0 },
                { name: "Younger Image POLARIZED", price: 400.0 },
            ],
            "Polarized Poly": [
                { name: "Single Vision POLARIZED POLY", price: 220.0 },
                { name: "FT-28 POLARIZED POLY", price: 300.0 },
                { name: "7x28 POLARIZED POLY", price: 315.0 },
                { name: "Essilor Natural POLARIZED POLY", price: 515.0 },
                { name: "KBCO IRx Pro POLARIZED POLY", price: 535.0 },
                { name: "Younger Image POLARIZED POLY", price: 495.0 },
            ],
            "Avalux Migraine": [
                { name: "Single Vision AVALUX MIGRAINE", price: 850.0 },
                { name: "Progressive AVALUX MIGRAINE", price: 975.0 },
            ],
            "Ray-Ban Single Vision": [
                { name: "Plastic RAY-BAN", price: 150.0 },
                { name: "Plastic w/ Blue Light RAY-BAN", price: 180.0 },
                { name: "Plastic Transitions RAY-BAN", price: 260.0 },
                { name: "Poly RAY-BAN", price: 190.0 },
                { name: "Poly w/ Blue Light RAY-BAN", price: 220.0 },
                { name: "Poly Transitions RAY-BAN", price: 300.0 },
                { name: "1.67 High-Index RAY-BAN", price: 375.0 },
                { name: "1.67 w/ Blue Light RAY-BAN", price: 405.0 },
                { name: "1.67 Transitions RAY-BAN", price: 485.0 },
            ],
            "Ray-Ban Progressive": [
                { name: "Plastic RAY-BAN PROG", price: 340.0 },
                { name: "Plastic w/ Blue Light RAY-BAN PROG", price: 370.0 },
                { name: "Plastic Transitions RAY-BAN PROG", price: 450.0 },
                { name: "Poly RAY-BAN PROG", price: 380.0 },
                { name: "Poly w/ Blue Light RAY-BAN PROG", price: 410.0 },
                { name: "Poly Transitions RAY-BAN PROG", price: 490.0 },
                { name: "1.67 High-Index RAY-BAN PROG", price: 500.0 },
                { name: "1.67 w/ Blue Light RAY-BAN PROG", price: 530.0 },
                { name: "1.67 Transitions RAY-BAN PROG", price: 610.0 },
            ],
            "Ray-Ban Sun": [
                { name: "Non-Polar RAY-BAN SUN", price: 350.0 },
                { name: "Polar RAY-BAN SUN", price: 390.0 },
                { name: "Polar BSAR RAY-BAN SUN", price: 440.0 },
                { name: "Polar Gradient BSAR RAY-BAN SUN", price: 450.0 },
                { name: "Polar Mirror BSAR RAY-BAN SUN", price: 475.0 },
            ],
            "Tints and Coatings": [
                { name: "Tint", price: 20.0 },
                { name: "Specialty Tint", price: 70.0 },
                { name: "Scratch Coat", price: 20.0 },
                { name: "U/V Coat", price: 20.0 },
                { name: "Standard A/R", price: 85.0 },
                { name: "A/R Strip", price: 25.0 },
                { name: "Crizal Easy A/R", price: 185.0 },
                { name: "Crizal Rock A/R", price: 215.0 },
                { name: "Unity A/R", price: 185.0 },
                { name: "Mirror Coat", price: 160.0 },
                { name: "Blue Light", price: 40.0 },
            ],
            "Overpower/Oversize": [
                { name: "SV over Â±4.00 SPH", price: 10.0 },
                { name: "SV over Â±8.00 SPH", price: 20.0 },
                { name: "Bifocal Add over +3.00", price: 15.0 },
                { name: "Bifocal Add over +4.00", price: 30.0 },
                { name: "Cylinder in Addtn to SPH", price: 20.0 },
                { name: "Prism", price: 10.0 },
                { name: "Eyesize over 58mm", price: 20.0 },
                { name: "Semi-Rimless Groove", price: 20.0 },
            ],
            Miscellaneous: [
                { name: "Oakley In-Line", price: 80.0 },
                { name: "Edge Down", price: 35.0 },
                { name: "Take PD for NP", price: 25.0 },
                { name: "Slab Off", price: 185.0 },
                { name: "Drill Mount", price: 40.0 },
                { name: "Press-On Prism", price: 75.0 },
                { name: "Roll", price: 30.0 },
                { name: "Polish", price: 30.0 },
                { name: "Roll and Polish", price: 45.0 },
                { name: "Safety Fee", price: 30.0 },
                { name: "Side Shields", price: 30.0 },
            ],
        };

        // --- VARIABLES ---
        let activeCat = "All";
        let currentInsurance = "None";
        let selectedLensName = "";
        let drawing = false;
        let isAllowancePlan = false;
        let globalAllowance = 0;
        let jobType = "Both"; // "Frame Only", "Lens Only", "Both"
        let allowSegHeightModal = true;
        let programmaticChange = false; // Flag to prevent prompt loop

        // --- INITIALIZATION ---
        const canvas = document.getElementById("sig-canvas");
        const ctx = canvas.getContext("2d");

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = 100;
        }

        window.onload = () => {
            resize();
            renderItems();

            // Theme toggle functionality
            const themeToggle = document.getElementById("theme-toggle");
            const currentTheme = localStorage.getItem("theme") || "light";
            if (currentTheme === "dark") {
                document.documentElement.setAttribute("data-theme", "dark");
                themeToggle.checked = true;
            }
            themeToggle.addEventListener("change", () => {
                if (themeToggle.checked) {
                    document.documentElement.setAttribute("data-theme", "dark");
                    localStorage.setItem("theme", "dark");
                } else {
                    document.documentElement.removeAttribute("data-theme");
                    localStorage.setItem("theme", "light");
                }
            });

            jobNumRef.on("value", (snapshot) => {
                const val = snapshot.val();
                document.getElementById("in-job-num").value = val || 31599;
            });

            historyRef.limitToLast(20).on("value", (snap) => {
                const hBody = document.getElementById("historyBody");
                hBody.innerHTML = "";
                const data = snap.val();
                if (!data) return;

                Object.keys(data)
                    .reverse()
                    .forEach((key) => {
                        const job = data[key];
                        const row = document.createElement("tr");
                        row.className = "hist-row";
                        row.style.cursor = "pointer";
                        row.innerHTML = `<td><b>${job.jobNum}</b></td><td>${job.optician}</td><td>${job.patient}</td><td>${job.plan}</td>`;
                        row.onclick = () => reloadJob(job);
                        hBody.appendChild(row);
                    });
            });

            handleInsuranceChange();
            if (typeof handleJobTypeChange === 'function') handleJobTypeChange('complete');
            updateSlip();
        };

        // --- NEW PATIENT PROMPT LOGIC ---
        function checkNewPatientPrompt() {
            const val = document.getElementById('in-name').value;
            // Only prompt if value exists, isn't empty, and wasn't changed by code
            if (!programmaticChange && val.trim() !== "") {
                document.getElementById('newPtPrompt').style.display = 'flex';
            }
            programmaticChange = false; // Reset flag
        }

        function confirmNewPatient() {
            document.getElementById('newPtPrompt').style.display = 'none';
            // Pre-fill form name to match input
            document.getElementById('in-pt-name').value = document.getElementById('in-name').value;
            // Open Language Modal
            document.getElementById('languageModal').style.display = 'flex';
        }

        function dismissPrompt() {
            document.getElementById('newPtPrompt').style.display = 'none';
        }

        // --- NEW PATIENT LOGIC ---
        function openPtSheet(lang) {
            // Apply translations
            const t = TRANSLATIONS[lang];
            document.getElementById("lbl-new-pt").innerText = t.newPt;
            document.getElementById("lbl-name").innerText = t.fullName;
            document.getElementById("lbl-dob").innerText = t.dob;
            document.getElementById("lbl-gender").innerText = t.gender;
            document.getElementById("lbl-address").innerText = t.address;
            document.getElementById("lbl-city").innerText = t.city;
            document.getElementById("lbl-state").innerText = t.state;
            document.getElementById("lbl-zip").innerText = t.zip;
            document.getElementById("lbl-ssn").innerText = t.ssn;
            document.getElementById("lbl-phone").innerText = t.phone;
            document.getElementById("lbl-email").innerText = t.email;
            document.getElementById("lbl-guard-header").innerText = t.guardHeader;
            document.getElementById("lbl-guard-name").innerText = t.guardName;
            document.getElementById("lbl-guard-rel").innerText = t.guardRel;
            document.getElementById("lbl-ins-header").innerText = t.insHeader;
            document.getElementById("lbl-ins-name").innerText = t.primIns;
            document.getElementById("lbl-ins-id").innerText = t.memId;
            document.getElementById("lbl-ins-holder").innerText = t.polHolder;
            document.getElementById("lbl-ins-dob").innerText = t.polDob;
            document.getElementById("lbl-hipaa-header").innerText = t.hipaaHeader;
            document.getElementById("lbl-hipaa-text").innerText = t.hipaaText;
            document.getElementById("btn-save").innerText = t.save;
            document.getElementById("btn-cancel").innerText = t.cancel;

            document.getElementById("languageModal").style.display = "none";
            document.getElementById("patientInfoOverlay").style.display = "flex";
        }

        function closeLanguageModal() {
            document.getElementById("languageModal").style.display = "none";
        }

        function showSegHeightModal() {
            if (!allowSegHeightModal) return;
            document.getElementById("segHeightModal").style.display = "flex";
            document.getElementById("seght-warning").style.display = "none";
        }

        function handleSegHeightYes() {
            document.getElementById("segHeightModal").style.display = "none";
            // Temporarily disable the modal from showing on programmatic focus
            allowSegHeightModal = false;
            // Set focus back to the input field
            document.getElementById("in-seght").focus();
            // Re-enable the modal for the next user-initiated focus event
            setTimeout(() => {
                allowSegHeightModal = true;
            }, 100);
        }

        function handleSegHeightNo() {
            document.getElementById("seght-warning").style.display = "block";
        }
        function handleRemakeClick() {
            const remakeCheckbox = document.getElementById("waiver-remake");
            if (remakeCheckbox.checked) {
                document.getElementById("remakeModal").style.display = "flex";
                document.getElementById("remake-reason").focus();
            } else {
                // If unchecked, clear the reason and update the slip to hide the section
                document.getElementById('remake-reason').value = '';
                updateSlip();
            }
        }

        function closeRemakeModal() {
            document.getElementById("remakeModal").style.display = "none";
            document.getElementById("waiver-remake").checked = false;
            document.getElementById("remake-reason").value = "";
            updateSlip();
        }

        function saveRemakeReason() {
            const reason = document.getElementById("remake-reason").value;
            if (reason.trim()) {
                document.getElementById("remakeModal").style.display = "none";
                updateSlip();
            } else {
                alert("Please enter a reason for the remake.");
            }
        }

        function checkMinor() {
            const dob = document.getElementById("in-pt-dob").value;
            if (dob) {
                const age = Math.floor((new Date() - new Date(dob)) / 31557600000);
                document.getElementById("guardianSection").style.display =
                    age < 18 ? "block" : "none";
            }
        }

        function formatPhoneNumber(input) {
            // Strip all non-digit characters from the input
            let digits = input.value.replace(/\D/g, '');

            // Trim the digits to a maximum of 10
            digits = digits.substring(0, 10);

            // Apply formatting based on the number of digits
            let formatted = '';
            if (digits.length > 0) {
                formatted = '(' + digits.substring(0, 3);
            }
            if (digits.length > 3) {
                formatted += ') ' + digits.substring(3, 6);
            }
            if (digits.length > 6) {
                formatted += '-' + digits.substring(6, 10);
            }
            input.value = formatted;
        }

        function syncPtName() {
            programmaticChange = true;
            document.getElementById("in-name").value =
                document.getElementById("in-pt-name").value;
            updateSlip();
        }

        function closePtForm(attach) {
            if (attach) {
                document.getElementById("patientPrintSheet").classList.add("active");
                document.getElementById("out-pt-name").textContent =
                    document.getElementById("in-pt-name").value;
                document.getElementById("out-pt-dob").textContent =
                    document.getElementById("in-pt-dob").value;
                document.getElementById("out-pt-gender").textContent =
                    document.getElementById("in-pt-gender").value;
                document.getElementById("out-pt-address").textContent =
                    document.getElementById("in-pt-address").value;
                document.getElementById("out-pt-city").textContent =
                    document.getElementById("in-pt-city").value;
                document.getElementById("out-pt-state").textContent =
                    document.getElementById("in-pt-state").value;
                document.getElementById("out-pt-zip").textContent =
                    document.getElementById("in-pt-zip").value;
                document.getElementById("out-pt-ssn").textContent =
                    document.getElementById("in-pt-ssn").value;
                document.getElementById("out-pt-phone").textContent =
                    document.getElementById("in-pt-phone").value;
                document.getElementById("out-pt-email").textContent =
                    document.getElementById("in-pt-email").value;

                document.getElementById("out-pt-ins-name").textContent =
                    document.getElementById("in-pt-ins-name").value;
                document.getElementById("out-pt-ins-id").textContent =
                    document.getElementById("in-pt-ins-id").value;
                document.getElementById("out-pt-ins-holder").textContent =
                    document.getElementById("in-pt-ins-holder").value;

                // Ensure main input matches form and prevent prompt
                programmaticChange = true;
                document.getElementById('in-name').value = document.getElementById('in-pt-name').value;
                updateSlip();
            } else {
                document
                    .getElementById("patientPrintSheet")
                    .classList.remove("active");
            }
            document.getElementById("patientInfoOverlay").style.display = "none";
        }

        // --- RELOAD DATA FUNCTION ---
        function reloadJob(data) {
            if (
                !confirm(
                    "Reload data for patient " +
                    data.patient +
                    "? (This will overwrite current form)",
                )
            )
                return;

            programmaticChange = true; // Prevent prompt on reload
            document.getElementById("in-name").value = data.patient || "";
            document.getElementById("in-dr").value = data.dr || "";
            document.getElementById("in-frame").value = data.frame || "";
            document.getElementById("in-pd").value = data.pd || "";
            document.getElementById("in-seght").value = data.seght || "";
            document.getElementById("insuranceSelect").value = data.plan || "None";
            selectedLensName = data.lensName || "";

            if (data.rx) {
                Object.keys(data.rx).forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) el.value = data.rx[id];
                });
            }

            if (data.billing) {
                Object.keys(data.billing).forEach((rowKey) => {
                    const row = document.querySelector(`tr[data-row="${rowKey}"]`);
                    if (row) {
                        row.querySelector(".ret").value = data.billing[rowKey].ret;
                        row.querySelector(".owe").textContent = data.billing[rowKey].owe;
                    }
                });
            }

            handleInsuranceChange();
            updateSlip();
        }

        // --- SIGNATURE PAD LOGIC ---
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            return {
                x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left,
                y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top,
            };
        }
        canvas.addEventListener("mousedown", (e) => {
            drawing = true;
            ctx.beginPath();
            const p = getPos(e);
            ctx.moveTo(p.x, p.y);
        });
        canvas.addEventListener("mousemove", (e) => {
            if (!drawing) return;
            const p = getPos(e);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
        });
        canvas.addEventListener("mouseup", () => (drawing = false));
        canvas.addEventListener("touchstart", (e) => {
            e.preventDefault();
            drawing = true;
            ctx.beginPath();
            const p = getPos(e);
            ctx.moveTo(p.x, p.y);
        });
        canvas.addEventListener("touchmove", (e) => {
            e.preventDefault();
            if (!drawing) return;
            const p = getPos(e);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
        });
        canvas.addEventListener("touchend", () => (drawing = false));
        function clearSig() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- SHOP LOGIC ---
        function attemptLogin() {
            const u = document.getElementById("userIn").value,
                p = document.getElementById("passIn").value;
            if (USERS[u] && USERS[u].pass === p) {
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("in-optician").value = USERS[u].initials;
                updateSlip();
            } else {
                document.getElementById("loginError").style.display = "block";
            }
        }

        function handleColorChoice(type) {
            ["clear", "tint", "polar", "mirror", "Transitions"].forEach((id) => {
                if (id !== type)
                    document.getElementById("color-" + id).checked = false;
            });
            const isChecked = document.getElementById("color-" + type).checked;
            const out = document.getElementById("chosen-color-text");
            if (isChecked) {
                if (type === "clear") {
                    out.value = "CLEAR";
                } else {
                    let color = prompt("What is the color for " + type + "?", "");
                    out.value = type.toUpperCase() + ": " + (color || "N/A");

                    // If not clear, check for commercial insurance and add to misc line
                    if (
                        ["tint", "polar", "mirror", "Transitions"].includes(type) &&
                        currentInsurance !== "None" &&
                        currentInsurance !== "MEDICAID" &&
                        currentInsurance !== "SCHOOL LETTER"
                    ) {
                        // Get price from price list
                        let itemPrice = 0;
                        if (type === "tint") itemPrice = 20.0;
                        else if (type === "mirror") itemPrice = 160.0;
                        else if (type === "polar") itemPrice = 80.0;
                        else if (type === "Transitions") itemPrice = 110.0;

                        let taxedAmount = itemPrice * 1.06;
                        let oweAmount = 0;

                        // Calculate owe amount based on insurance type
                        if (!isAllowancePlan) {
                            // STANDARD COMMERCIAL: Prompt for Copay
                            let copayStr = prompt(`What is the copay for ${type}?`, "0");
                            if (copayStr === null) return;
                            let copay = parseFloat(copayStr) || 0;
                            oweAmount = copay * 1.06;
                        } else {
                            // ALLOWANCE PLAN: Prompt for allowance
                            let allowanceStr = prompt(
                                `What is the insurance allowance for ${type}?`,
                                "0",
                            );
                            if (allowanceStr === null) return;
                            let allowance = parseFloat(allowanceStr) || 0;
                            oweAmount = Math.max(0, taxedAmount - allowance);
                        }

                        // Find first empty misc row and fill it
                        for (let rowId of ["m1", "m2", "m3"]) {
                            const row = document.querySelector(`tr[data-row="${rowId}"]`);
                            const descField = row.querySelector(".m-desc");
                            if (descField && descField.value === "") {
                                const itemName = (color || "N/A").toUpperCase();
                                descField.value = type.toUpperCase() + ": " + itemName;
                                row.querySelector(".ret").value = itemPrice;
                                row.querySelector(".tax").textContent =
                                    taxedAmount.toFixed(2);
                                row.querySelector(".owe").textContent = oweAmount.toFixed(2);
                                break;
                            }
                        }
                    }
                }
            } else {
                out.value = "";
            }
            updateSlip();
        }
        function handleDoctorChange() {
            const select = document.getElementById('dr-select');
            const input = document.getElementById('in-dr');

            if (select.value === 'Other') {
                // If Other, show the text box and clear it so they can type
                input.style.display = 'block';
                input.value = "";
                input.focus();
            } else {
                // If a specific doctor, hide text box and force the value into the input
                input.style.display = 'none';
                input.value = select.value;
            }

            // Trigger updates
            updateSlip();

            // Check validation (if validateForm exists)
            if (typeof validateForm === "function") validateForm();
        }

        // --- UPDATED INSURANCE LOGIC ---
        function handleInsuranceChange() {
            currentInsurance = document.getElementById("insuranceSelect").value;

            // RESET VARIABLES
            isAllowancePlan = false;
            globalAllowance = 0;
            jobType = "Both";

            const showPay =
                currentInsurance !== "MEDICAID" &&
                currentInsurance !== "SCHOOL LETTER";
            const showMedicaid = currentInsurance === "MEDICAID";
            const showSchool = currentInsurance === "SCHOOL LETTER";

            document.getElementById("pay-title").style.display = showPay
                ? "block"
                : "none";
            document.getElementById("pay-box").style.display = showPay
                ? "block"
                : "none";
            document.getElementById("medicaid-sub-box").style.display = showMedicaid
                ? "block"
                : "none";
            document.getElementById("school-sub-box").style.display = showSchool
                ? "block"
                : "none";

            // COMMERCIAL INSURANCE LOGIC (Not Medicaid/School/None)
            if (
                currentInsurance !== "MEDICAID" &&
                currentInsurance !== "SCHOOL LETTER" &&
                currentInsurance !== "None"
            ) {
                // 1. ASK IF ALLOWANCE PLAN
                if (
                    confirm(
                        "Is this an ALLOWANCE PLAN? (e.g. $350 total allowance to use freely)\nClick OK for YES.\nClick Cancel for NO.",
                    )
                ) {
                    isAllowancePlan = true;
                    let input = prompt("Enter Total Allowance Amount (e.g. 350):", "0");
                    globalAllowance = parseFloat(input) || 0;
                    alert(
                        `Allowance Plan Active. $${globalAllowance} will be deducted from the Retail cost of the glasses.`,
                    );
                } else {
                    // CHECK FOR 20% DISCOUNT CONDITION
                    const isVspOrEyemed =
                        currentInsurance.toUpperCase().includes("VSP") ||
                        currentInsurance.toUpperCase().includes("EYE-MED");
                    if (
                        isVspOrEyemed &&
                        (jobType === "Frame Only" || jobType === "Lens Only")
                    ) {
                        alert(
                            `Job Type: ${jobType}\nPlan: ${currentInsurance}\n\nAuto-Applying 20% Discount to Frame Retail + Tax.`,
                        );
                    }
                }
            }

            renderItems(document.getElementById("searchInput").value);
            updateSlip();
        }

        function toggleCheckInput() {
            const isChecked = document.getElementById("pay-check").checked;
            document.getElementById("check-input-area").style.display = isChecked
                ? "inline"
                : "none";
            updateSlip();
        }

        function toggleCardOptions() {
            const isChecked = document.getElementById("pay-card").checked;
            document.getElementById("card-types").style.display = isChecked
                ? "grid"
                : "none";
            updateSlip();
        }

        function toggleTimeInput() {
            const isChecked = document.getElementById('promise-time').checked;
            document.getElementById('promise-time-input').style.display = isChecked ? 'inline-block' : 'none';
            if (!isChecked) {
                document.getElementById('promise-time-input').value = '';
            }
            updateSlip();
        }

        function calcRow() {
            updateSlip();
        }
        function handleDiffToggle() {
            updateSlip();
        }

        function triggerFrameAllowance() {
            const frameRetail =
                parseFloat(document.getElementById("frameRetail").value) || 0;
            const uiRow = document.querySelector('tr[data-row="frame"]');

            if (
                currentInsurance === "MEDICAID" ||
                currentInsurance === "SCHOOL LETTER"
            ) {
                uiRow.querySelector(".owe").textContent = "0.00";
            } else if (currentInsurance === "None") {
                // Private Pay
                uiRow.querySelector(".owe").textContent = (
                    frameRetail * 1.06
                ).toFixed(2);
            } else {
                // COMMERCIAL LOGIC
                if (isAllowancePlan) {
                    // Disregard prompts, just set Retail + Tax (Deduction happens at total)
                    uiRow.querySelector(".owe").textContent = (
                        frameRetail * 1.06
                    ).toFixed(2);
                } else {
                    // CHECK FOR 20% DISCOUNT
                    const isVspOrEyemed =
                        currentInsurance.toUpperCase().includes("VSP") ||
                        currentInsurance.toUpperCase().includes("EYE-MED");

                    if (
                        isVspOrEyemed &&
                        (jobType === "Frame Only" || jobType === "Lens Only")
                    ) {
                        // Apply 20% Discount to Retail + Tax
                        let totalWithTax = frameRetail * 1.06;
                        let discounted = totalWithTax * 0.8; // 20% Off
                        uiRow.querySelector(".owe").textContent = discounted.toFixed(2);
                    } else if (frameRetail > 0) {
                        // Standard Logic (Ask for Frame Allowance if not special case)
                        const allowance =
                            parseFloat(
                                prompt(
                                    `Enter Standard Frame Allowance for ${currentInsurance}:`,
                                    "0",
                                ),
                            ) || 0;
                        if (frameRetail > allowance) {
                            let remainder = (frameRetail - allowance) * 0.8;
                            uiRow.querySelector(".owe").textContent = (
                                remainder * 1.06
                            ).toFixed(2);
                        } else {
                            uiRow.querySelector(".owe").textContent = "0.00";
                        }
                    }
                }
            }
            updateSlip();
        }

        function applyCopay(itemName, itemPrice, cat) {
            const miscCategories = ["Tints and Coatings", "Overpower/Oversize", "Miscellaneous"];
            let uiRow;
            let isMisc = miscCategories.includes(cat);

            if (isMisc) {
                // Find the first available misc row
                for (const rowId of ['m1', 'm2', 'm3']) {
                    const row = document.querySelector(`tr[data-row="${rowId}"]`);
                    const descInput = row.querySelector('.m-desc');
                    if (descInput && descInput.value.trim() === '') {
                        uiRow = row;
                        descInput.value = itemName; // Set the description
                        break;
                    }
                }
                if (!uiRow) {
                    alert("All miscellaneous fields are full. Cannot add item.");
                    return;
                }
            } else {
                // It's a lens
                uiRow = document.querySelector('tr[data-row="lens"]');
                selectedLensName = itemName;
            }

            // The rest of the logic is mostly the same, but it operates on uiRow
            if (
                currentInsurance === "MEDICAID" ||
                currentInsurance === "SCHOOL LETTER"
            ) {
                uiRow.querySelector(".ret").value = 0;
                uiRow.querySelector(".tax").textContent = "0.00";
                uiRow.querySelector(".owe").textContent = "0.00";
            } else if (currentInsurance !== "None") {
                if (isAllowancePlan) {
                    // ALLOWANCE PLAN: Prompt for allowance and subtract from taxed total
                    let allowanceStr = prompt(`What is the insurance allowance for ${itemName}?`, "0");
                    if (allowanceStr === null) {
                        if (isMisc) uiRow.querySelector('.m-desc').value = ''; // Clear if cancelled
                        return;
                    }
                    let allowance = parseFloat(allowanceStr) || 0;

                    uiRow.querySelector(".ret").value = itemPrice;
                    let taxedAmount = itemPrice * 1.06;
                    uiRow.querySelector(".tax").textContent = taxedAmount.toFixed(2);
                    uiRow.querySelector(".owe").textContent = Math.max(0, taxedAmount - allowance).toFixed(2);
                } else {
                    // STANDARD COMMERCIAL: Prompt for Copay
                    let val = prompt(`What is the copay for ${itemName}?`, "0");
                    if (val === null) {
                        if (isMisc) uiRow.querySelector('.m-desc').value = ''; // Clear if cancelled
                        return;
                    }
                    let copay = parseFloat(val) || 0;

                    uiRow.querySelector(".ret").value = itemPrice;
                    uiRow.querySelector(".tax").textContent = (itemPrice * 1.06).toFixed(2);
                    uiRow.querySelector(".owe").textContent = (copay * 1.06).toFixed(2);
                }
            } else {
                // Private Pay Logic
                uiRow.querySelector(".ret").value = itemPrice;
                uiRow.querySelector(".tax").textContent = (itemPrice * 1.06).toFixed(2);
                uiRow.querySelector(".owe").textContent = (itemPrice * 1.06).toFixed(2);
            }
            updateSlip();
        }

        function printJob() {
            document.getElementById("out-sig-image").src = canvas.toDataURL();
            let currentNum = parseInt(document.getElementById("in-job-num").value);
            let nextNum = currentNum + 1;
            const snapshot = {
                jobNum: currentNum,
                optician: document.getElementById("in-optician").value,
                patient: document.getElementById("in-name").value || "No Name",
                plan: document.getElementById("insuranceSelect").value,
                dr: document.getElementById("in-dr").value,
                frame: document.getElementById("in-frame").value,
                pd: document.getElementById("in-pd").value,
                seght: document.getElementById("in-seght").value,
                lensName: selectedLensName,
                rx: {
                    "rx-od-sph": document.getElementById("rx-od-sph").value,
                    "rx-od-cyl": document.getElementById("rx-od-cyl").value,
                    "rx-od-axis": document.getElementById("rx-od-axis").value,
                    "rx-od-add": document.getElementById("rx-od-add").value,
                    "rx-od-prism": document.getElementById("rx-od-prism").value,
                    "rx-os-sph": document.getElementById("rx-os-sph").value,
                    "rx-os-cyl": document.getElementById("rx-os-cyl").value,
                    "rx-os-axis": document.getElementById("rx-os-axis").value,
                    "rx-os-add": document.getElementById("rx-os-add").value,
                    "rx-os-prism": document.getElementById("rx-os-prism").value,
                },
                billing: {
                    frame: {
                        ret: document.getElementById("frameRetail").value,
                        owe: document.querySelector('tr[data-row="frame"] .owe')
                            .textContent,
                    },
                    lens: {
                        ret: document.querySelector('tr[data-row="lens"] .ret').value,
                        owe: document.querySelector('tr[data-row="lens"] .owe')
                            .textContent,
                    },
                    coat: {
                        ret: document.querySelector('tr[data-row="coat"] .ret').value,
                        owe: document.querySelector('tr[data-row="coat"] .owe')
                            .textContent,
                    },
                    m1: {
                        ret: document.querySelector('tr[data-row="m1"] .ret').value,
                        owe: document.querySelector('tr[data-row="m1"] .owe').textContent,
                    },
                    m2: {
                        ret: document.querySelector('tr[data-row="m2"] .ret').value,
                        owe: document.querySelector('tr[data-row="m2"] .owe').textContent,
                    },
                    m3: {
                        ret: document.querySelector('tr[data-row="m3"] .ret').value,
                        owe: document.querySelector('tr[data-row="m3"] .owe').textContent,
                    },
                },
                timestamp: firebase.database.ServerValue.TIMESTAMP,
            };
            historyRef.push(snapshot);
            jobNumRef
                .set(nextNum)
                .then(() => {
                    window.print();
                })
                .catch((error) => {
                    alert("Sync Failed! " + error.message);
                });
        }

        function updateSlip() {
            const temp = document.getElementById("jobSlipTemplate").innerHTML;
            const slots = document.querySelectorAll(".slip-content");

            let payMethod = "";
            if (document.getElementById("pay-cash").checked) payMethod = "CASH";
            else if (document.getElementById("pay-check").checked)
                payMethod = "CHECK #" + document.getElementById("check-num").value;
            else if (document.getElementById("pay-card").checked) {
                let cardType = "";
                const labels = ["Visa", "MC", "Discover", "AMEX", "HSA/FSA"];
                document.querySelectorAll(".card-sub").forEach((c, idx) => {
                    if (c.checked) cardType = labels[idx];
                });
                payMethod = "CARD" + (cardType ? " (" + cardType + ")" : "");
            }
            let isPaid = payMethod !== "";
            let insDisplay = currentInsurance;
            if (currentInsurance === "MEDICAID") {
                const mType = document.getElementById("medicaid-type").value;
                const mCode = document.getElementById("medicaid-code").value;
                insDisplay = `<span class="med-details-print">MEDICAID (${mType} / ${mCode})</span>`;
            } else if (currentInsurance === "SCHOOL LETTER") {
                const sName = document.getElementById("in-school-name").value;
                insDisplay = `SCHOOL: ${sName || "N/A"}`;
            }

            let promisedText = [];
            if (document.getElementById('promise-call').checked) promisedText.push('Call');
            if (document.getElementById('promise-text').checked) promisedText.push('Text');
            if (document.getElementById('promise-mail').checked) promisedText.push('Mail');
            if (document.getElementById('promise-time').checked) {
                const timeVal = document.getElementById('promise-time-input').value;
                if (timeVal) {
                    promisedText.push(`Time: ${timeVal}`);
                } else {
                    promisedText.push('Time');
                }
            }
            const promisedString = promisedText.join(', ');

            const isRemake = document.getElementById('waiver-remake').checked;
            const remakeReason = document.getElementById('remake-reason').value;

            // --- LIVE CALCULATION LOOP ---
            let runningTotal = 0;
            let totalRetail = 0; // For Allowance Calc

            ["frame", "lens", "coat", "m1", "m2", "m3"].forEach((k) => {
                const ui = document.querySelector(`tr[data-row="${k}"]`);
                if (ui) {
                    const ret = parseFloat(ui.querySelector(".ret").value) || 0;
                    let owe = parseFloat(ui.querySelector(".owe").textContent) || 0;

                    totalRetail += ret;

                    // Update Tax Cell
                    const taxCell = ui.querySelector(".tax");
                    if (taxCell) {
                        if (
                            currentInsurance.includes("MEDICAID") ||
                            currentInsurance === "SCHOOL LETTER"
                        ) {
                            taxCell.textContent = "0.00";
                        } else {
                            taxCell.textContent = (ret * 1.06).toFixed(2);
                        }
                    }
                    runningTotal += owe;
                }
            });

            // --- ALLOWANCE PLAN MATH ---
            let finalOwe = runningTotal;
            let allowanceDisplay = "";

            if (isAllowancePlan && globalAllowance > 0) {
                // Logic: Take allowance off the Retail Cost
                // We calculate Overage, then Tax the Overage
                let taxableOverage = Math.max(0, totalRetail - globalAllowance);
                finalOwe = taxableOverage * 1.06;
                allowanceDisplay = `<br><span style="font-size:0.8em; color:blue;">(Retail $${totalRetail.toFixed(2)} - Allow $${globalAllowance.toFixed(2)}) + Tax</span>`;
            }

            // UPDATE SIDEBAR DISPLAY
            const sidebarBal = document.getElementById("ui-bal");
            if (sidebarBal) {
                if (isPaid) {
                    sidebarBal.innerHTML = `Total Bill: $${finalOwe.toFixed(2)} ${allowanceDisplay}<br><span style="color:var(--success); font-size:1.2em; font-weight:900;">PAID: ${payMethod}</span><br>Due: $0.00`;
                } else {
                    sidebarBal.innerHTML = `Total Owe: $${finalOwe.toFixed(2)} ${allowanceDisplay}`;
                }
            }

            // UPDATE PRINT SLIPS
            slots.forEach((s) => {
                s.innerHTML = temp;
                [
                    "name",
                    "dr",
                    "frame",
                    "frame-a",
                    "frame-dbl",
                    "pd",
                    "seght",
                    "optician",
                    "job-num",
                ].forEach((f) => {
                    const val = document.getElementById("in-" + f)
                        ? document.getElementById("in-" + f).value
                        : "";
                    s.querySelectorAll(".out-" + f).forEach(
                        (el) => (el.textContent = val),
                    );
                });
                s.querySelectorAll(".out-ins-full").forEach(
                    (el) => (el.innerHTML = insDisplay),
                );
                s.querySelectorAll(".out-promised").forEach(
                    (el) => (el.textContent = promisedString),
                );
                const remakeRow = s.querySelector('.out-remake-row');
                if (remakeRow) {
                    if (isRemake && remakeReason.trim() !== "") {
                        remakeRow.style.display = 'flex';
                        const reasonEl = remakeRow.querySelector('.out-remake-reason');
                        if (reasonEl) reasonEl.textContent = remakeReason;
                    } else {
                        remakeRow.style.display = 'none';
                    }
                }
                s.querySelectorAll(".out-color").forEach(
                    (el) =>
                    (el.textContent =
                        document.getElementById("chosen-color-text").value),
                );
                s.querySelectorAll(".out-pay-method").forEach(
                    (el) => (el.textContent = payMethod),
                );
                s.querySelectorAll(".out-full-lens-name").forEach(
                    (el) => (el.textContent = selectedLensName),
                );
                [
                    "rx-od-sph",
                    "rx-od-cyl",
                    "rx-od-axis",
                    "rx-od-add",
                    "rx-od-prism",
                    "rx-os-sph",
                    "rx-os-cyl",
                    "rx-os-axis",
                    "rx-os-add",
                    "rx-os-prism",
                ].forEach((f) => {
                    s.querySelectorAll(".out-" + f).forEach(
                        (el) => (el.textContent = document.getElementById(f).value),
                    );
                });
                s.querySelectorAll(".out-date").forEach(
                    (el) => (el.textContent = new Date().toLocaleDateString()),
                );

                ["frame", "lens", "coat", "m1", "m2", "m3"].forEach((k) => {
                    const ui = document.querySelector(`tr[data-row="${k}"]`);
                    if (ui) {
                        const ret = parseFloat(ui.querySelector(".ret").value) || 0;
                        const owe = parseFloat(ui.querySelector(".owe").textContent) || 0;

                        if (k.startsWith("m")) {
                            const customName = ui
                                .querySelector(".m-desc")
                                .value.toUpperCase();
                            s.querySelectorAll(".out-" + k + "-name").forEach(
                                (el) =>
                                    (el.textContent = customName || "MISC " + k.charAt(1)),
                            );
                        }

                        s.querySelectorAll(".out-ret-" + k).forEach(
                            (el) =>
                            (el.textContent =
                                currentInsurance.includes("MEDICAID") ||
                                    currentInsurance === "SCHOOL LETTER"
                                    ? "$0.00"
                                    : ret
                                        ? "$" + ret.toFixed(2)
                                        : ""),
                        );
                        s.querySelectorAll(".out-tax-" + k).forEach(
                            (el) =>
                            (el.textContent =
                                currentInsurance.includes("MEDICAID") ||
                                    currentInsurance === "SCHOOL LETTER"
                                    ? "$0.00"
                                    : ret
                                        ? "$" + (ret * 1.06).toFixed(2)
                                        : ""),
                        );
                        s.querySelectorAll(".out-owe-" + k).forEach(
                            (el) => (el.textContent = owe ? "$" + owe.toFixed(2) : ""),
                        );
                    }
                });

                // Override totals if Allowance Plan
                if (isAllowancePlan) {
                    s.querySelectorAll(".out-total-before").forEach(
                        (el) =>
                            (el.textContent = "$" + finalOwe.toFixed(2) + " (Inc. Allow)"),
                    );
                } else {
                    s.querySelectorAll(".out-total-before").forEach(
                        (el) => (el.textContent = "$" + runningTotal.toFixed(2)),
                    );
                }
                s.querySelectorAll(".out-total-all").forEach(
                    (el) => (el.textContent = "$" + (isPaid ? 0 : finalOwe).toFixed(2)),
                );
            });

            // HANDLE WAIVERS
            let wHTML = "";
            if (document.getElementById("waiver-expired").checked)
                wHTML +=
                    "<p><b>EXPIRED Rx WAIVER:</b> I have been cautioned by my Optician that my Eye Exam has expired and it is in my best interest to get a new exam. I will not hold Pal Optial responsible for any issues regarding my vision quality in the new glasses.</p>";
            if (document.getElementById("waiver-pof").checked)
                wHTML +=
                    "<p><b>PATIENT OWN FRAME (POF):</b> I understand that since my frame is either not new/ not covered under any warranty. While Pal Optical takes the utmost care with your glasses, breakages do occur. Pal Optical will not be held liable should a breakage occur in the lab process, mounting process, or during adjustment of the frame.</p>";
            if (document.getElementById("waiver-thick").checked)
                wHTML +=
                    "<p><b>FRAME THICKNESS WAIVER:</b> I have been cautioned by my optician that once my rx is put in the frame I have chosen the lenses will be uncomfortably thick and heavy. I understand that by choosing this frame after being warned Pal Oprical will not remake my eyeglasses into a different frame. If I want a different frame after lenses have been made to the first frame all cost will fall to me.</p>";
            if (document.getElementById("waiver-poly").checked)
                wHTML +=
                    "<p><b>CHILD POLY WAIVER:</b> I have been cautioned by my optician that my child should have polycarbonate lenses due to poly being extremely impact resistant and shatter resistant, thereby safer for my childs glasses. I am choosing to not get poly and will not hold Pal Optical responsible should my childs lenses shatter or break and injure them.</p>";
            if (document.getElementById("waiver-noline").checked)
                wHTML +=
                    "<p><b>LINED TO NO LINE WAIVER:</b> I have been cautioned by my optician that switching from a lined bifocal to a no-line bifocal or progressive is very difficult to adjust to if you can at all. With a no-line you have a diminished field of view where as with the lined bi-focal you have the entire lens. I understand Pal Optical will not remake my lens to a no-line if I dont line the field of view in the progressive/no- line bifocal.</p>";
            if (document.getElementById("waiver-semirim").checked)
                wHTML +=
                    "<p><b>SEMI-RIMLESS CHIP WAIVER:</b> I have been warned of chipping and cracking of my lenses if I choose to not get polycarbonate lenses in my semi-rimless frame. The way the edges are exposed make the lens more prone to chipping. Polycarbonate will not chip.</p>";
            const wp = document.getElementById("waiverPage");
            if (wHTML !== "") {
                wp.classList.add("active");
                document.getElementById("waiverTextDisplay").innerHTML = wHTML;
                document
                    .querySelectorAll(".out-name")
                    .forEach(
                        (el) =>
                            (el.textContent = document.getElementById("in-name").value),
                    );
            } else wp.classList.remove("active");

            // Also validate when lens is selected (triggered by applyCopay)
            if (typeof validateForm === "function") validateForm();
        }

        function renderItems(search = "") {
            const c = document.getElementById("lensContainer"),
                term = search.toLowerCase();
            c.innerHTML = "";
            const MEDICAID_LENSES = [
                "Single Vision Plastic",
                "Flat Top 28 Bifocal Plastic",
                "Younger Image Plastic",
                "Single Vision POLY",
                "Flat Top 28 Bifocal POLY",
                "Younger Image POLY",
            ];

            // CHECK IF INSURANCE IS ACTIVE (NOT NONE, NOT MEDICAID, NOT SCHOOL)
            const isInsuranceActive =
                !currentInsurance.includes("MEDICAID") &&
                currentInsurance !== "SCHOOL LETTER" &&
                currentInsurance !== "None";

            Object.keys(MASTER_PRICE_LIST).forEach((cat) => {
                if (activeCat !== "All" && activeCat !== cat) return;
                MASTER_PRICE_LIST[cat].forEach((i) => {
                    if (
                        (currentInsurance === "MEDICAID" ||
                            currentInsurance === "SCHOOL LETTER") &&
                        !MEDICAID_LENSES.some((m) =>
                            i.name.toLowerCase().includes(m.toLowerCase()),
                        )
                    )
                        return;

                    if (i.name.toLowerCase().includes(term)) {
                        const d = document.createElement("div");
                        d.className = "lens-card";

                        // IF INSURANCE IS ACTIVE, CHANGE DISPLAY TO "ADD W/ COPAY"
                        let priceDisplay = `$${i.price}`;
                        if (
                            currentInsurance.includes("MEDICAID") ||
                            currentInsurance === "SCHOOL LETTER"
                        )
                            priceDisplay = "$0.00";
                        else if (isInsuranceActive)
                            priceDisplay =
                                "<span style='color:green; font-weight:bold;'>Add w/ Copay</span>";

                        d.innerHTML = `<b>${i.name}</b><br>${priceDisplay}`;
                        d.onclick = () => {
                            applyCopay(i.name, i.price, cat);
                        };
                        c.appendChild(d);
                    }
                });
            });
        }

        const nav = document.getElementById("categoryNav");
        nav.innerHTML =
            '<button class="cat-btn active" onclick="setCategory(\'All\', this)">All</button>';
        Object.keys(MASTER_PRICE_LIST).forEach((cat) => {
            const b = document.createElement("button");
            b.className = "cat-btn";
            b.textContent = cat;
            b.onclick = () => setCategory(cat, b);
            nav.appendChild(b);
        });
        function setCategory(c, b) {
            activeCat = c;
            document
                .querySelectorAll(".cat-btn")
                .forEach((btn) => btn.classList.remove("active"));
            b.classList.add("active");
            renderItems(document.getElementById("searchInput").value);
        }
        document
            .getElementById("searchInput")
            .addEventListener("input", (e) => renderItems(e.target.value));
        
        // --- PRINT BUTTON VALIDATION (UPDATED) ---
        function validateForm() {
            const printBtn = document.getElementById("printBtn");
            const validationMsg = document.getElementById("validationMessage");

            // Check job type
            const isFrameOnly = document.getElementById('job-type-frame').checked;
            const isLensOnly = document.getElementById('job-type-lens').checked;

            let missingFields = [];

            // Fields always required
            if (!document.getElementById("in-name").value.trim()) missingFields.push("Patient Name");
            if (!document.getElementById("pt-phone").value.trim()) missingFields.push("Patient Phone");

            // Frame-related fields (Required for Complete and Frame Only)
            if (!isLensOnly) {
                if (!document.getElementById("in-frame").value.trim()) missingFields.push("Frame");
            }

            // Lens/RX-related fields (Required for Complete and Lens Only)
            if (!isFrameOnly) {
                const lensRet = document.querySelector('tr[data-row="lens"] .ret').value;
                if (!lensRet || lensRet === "0") missingFields.push("Lens (select from catalog)");
                if (!document.getElementById("in-pd").value.trim()) missingFields.push("P.D.");
                if (!document.getElementById("in-dr").value.trim()) missingFields.push("Doctor");
                if (!document.getElementById("rx-od-sph").value.trim()) missingFields.push("RX OD SPH");
                if (!document.getElementById("rx-od-cyl").value.trim()) missingFields.push("RX OD CYL");
                if (!document.getElementById("rx-od-axis").value.trim()) missingFields.push("RX OD AXIS");
                if (!document.getElementById("rx-os-sph").value.trim()) missingFields.push("RX OS SPH");
                if (!document.getElementById("rx-os-cyl").value.trim()) missingFields.push("RX OS CYL");
                if (!document.getElementById("rx-os-axis").value.trim()) missingFields.push("RX OS AXIS");

                const hasAddPower = document.getElementById("rx-od-add").value.trim() || document.getElementById("rx-os-add").value.trim();
                const isNoLine = document.getElementById("rx-dvo").checked || document.getElementById("rx-nvo").checked || document.getElementById("rx-ivo").checked;
                const segHeightRequired = hasAddPower && !isNoLine;
                if (segHeightRequired && !document.getElementById("in-seght").value.trim()) {
                    missingFields.push("Seg Height (required for bifocals)");
                }
            }

            if (missingFields.length > 0) {
                // Disable the print button
                printBtn.disabled = true;
                validationMsg.textContent = "Required: " + missingFields.join(", ");
                validationMsg.classList.add("visible");
                return false;
            } else {
                // Enable the print button
                printBtn.disabled = false;
                validationMsg.classList.remove("visible");
                return true;
            }
        }

        function resetForm() {
            if (confirm("Are you sure you want to reset the form? All unsaved data will be lost.")) {
                location.reload();
            }
        }

        // Add event listeners to required fields for real-time validation
        document.addEventListener("DOMContentLoaded", function () {
            // Initial validation on page load
            validateForm();

            // Add input listeners to required fields
            const requiredFields = [
                "in-name",
                "in-frame",
                "in-pd",
                "in-dr",
                "pt-phone",
                "in-seght",
                "rx-od-sph",
                "rx-od-cyl",
                "rx-od-axis",
                "rx-od-add",
                "rx-od-prism",
                "rx-os-sph",
                "rx-os-cyl",
                "rx-os-axis",
                "rx-os-add",
                "rx-os-prism",
                "rx-dvo",
                "rx-nvo",
                "rx-ivo",
            ];
            requiredFields.forEach(function (fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener("input", validateForm);
                    field.addEventListener("change", validateForm);
                }
            });
        });
    </script>
</body>


</html>
